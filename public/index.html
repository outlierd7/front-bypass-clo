<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üîí Cloaker Pro - Painel de Controle</title>
  <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg-primary: #0f0f23; --bg-secondary: #1a1a2e; --bg-card: #16213e;
      --accent: #e94560; --accent-hover: #ff6b6b; --success: #00d9a5;
      --warning: #ffc107; --danger: #dc3545; --text-primary: #ffffff;
      --text-secondary: #a0a0b0; --border: #2a2a4a;
    }
    body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; }
    
    .sidebar { position: fixed; left: 0; top: 0; width: 260px; height: 100vh; background: var(--bg-secondary); border-right: 1px solid var(--border); padding: 20px; z-index: 100; }
    .logo { display: flex; align-items: center; gap: 12px; padding: 10px 0 30px; border-bottom: 1px solid var(--border); margin-bottom: 20px; }
    .logo i { font-size: 28px; color: var(--accent); }
    .logo h1 { font-size: 20px; font-weight: 600; }
    .nav-menu { list-style: none; }
    .nav-item { margin-bottom: 5px; }
    .nav-link { display: flex; align-items: center; gap: 12px; padding: 12px 15px; border-radius: 10px; color: var(--text-secondary); text-decoration: none; transition: all 0.3s; cursor: pointer; }
    .nav-link:hover, .nav-link.active { background: var(--bg-card); color: var(--text-primary); }
    .nav-link.active { background: linear-gradient(135deg, var(--accent), #ff6b6b); color: white; }
    .nav-link i { font-size: 20px; }

    .main { margin-left: 260px; padding: 30px; min-height: 100vh; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 15px; }
    .header h2 { font-size: 28px; font-weight: 600; }
    .header-actions { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }

    .btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px; border-radius: 10px; border: none; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.3s; }
    .btn-primary { background: linear-gradient(135deg, var(--accent), #ff6b6b); color: white; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(233, 69, 96, 0.4); }
    .btn-secondary { background: var(--bg-card); color: var(--text-primary); border: 1px solid var(--border); }
    .btn-secondary:hover { background: var(--bg-secondary); }
    .btn-danger { background: var(--danger); color: white; }
    .btn-sm { padding: 6px 12px; font-size: 12px; }

    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .stat-card { background: var(--bg-card); border-radius: 15px; padding: 20px; border: 1px solid var(--border); position: relative; overflow: hidden; }
    .stat-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, var(--accent), #ff6b6b); }
    .stat-card.success::before { background: linear-gradient(90deg, var(--success), #00ffcc); }
    .stat-card.warning::before { background: linear-gradient(90deg, var(--warning), #ffdd57); }
    .stat-card.danger::before { background: linear-gradient(90deg, var(--danger), #ff6b6b); }
    .stat-icon { width: 45px; height: 45px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; margin-bottom: 12px; }
    .stat-card .stat-icon { background: rgba(233, 69, 96, 0.2); color: var(--accent); }
    .stat-card.success .stat-icon { background: rgba(0, 217, 165, 0.2); color: var(--success); }
    .stat-card.warning .stat-icon { background: rgba(255, 193, 7, 0.2); color: var(--warning); }
    .stat-card.danger .stat-icon { background: rgba(220, 53, 69, 0.2); color: var(--danger); }
    .stat-value { font-size: 28px; font-weight: 700; margin-bottom: 5px; }
    .stat-label { color: var(--text-secondary); font-size: 13px; }

    .card { background: var(--bg-card); border-radius: 15px; border: 1px solid var(--border); margin-bottom: 20px; }
    .card-header { display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid var(--border); }
    .card-title { font-size: 18px; font-weight: 600; display: flex; align-items: center; gap: 10px; }
    .card-body { padding: 20px; }

    .table-container { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border); }
    th { color: var(--text-secondary); font-weight: 500; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; }
    tr:hover { background: rgba(255, 255, 255, 0.02); }

    .badge { display: inline-flex; align-items: center; gap: 5px; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 500; }
    .badge-success { background: rgba(0, 217, 165, 0.2); color: var(--success); }
    .badge-danger { background: rgba(220, 53, 69, 0.2); color: var(--danger); }
    .badge-warning { background: rgba(255, 193, 7, 0.2); color: var(--warning); }
    .badge-info { background: rgba(23, 162, 184, 0.2); color: #17a2b8; }

    .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; margin-bottom: 20px; }
    .chart-container { height: 280px; position: relative; }

    .filters { display: flex; gap: 8px; flex-wrap: wrap; }
    .filter-btn { padding: 8px 14px; border-radius: 8px; background: var(--bg-secondary); border: 1px solid var(--border); color: var(--text-secondary); cursor: pointer; transition: all 0.3s; font-size: 12px; }
    .filter-btn:hover, .filter-btn.active { background: var(--accent); color: white; border-color: var(--accent); }

    .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.8); z-index: 1000; align-items: center; justify-content: center; }
    .modal.active { display: flex; }
    .modal-content { background: var(--bg-card); border-radius: 20px; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; border: 1px solid var(--border); }
    .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid var(--border); }
    .modal-body { padding: 20px; }
    .modal-close { background: none; border: none; color: var(--text-secondary); font-size: 24px; cursor: pointer; }

    .form-group { margin-bottom: 20px; }
    .form-label { display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 14px; }
    .form-input, .form-select { width: 100%; padding: 12px 15px; border-radius: 10px; border: 1px solid var(--border); background: var(--bg-secondary); color: var(--text-primary); font-size: 14px; }
    .form-input:focus, .form-select:focus { outline: none; border-color: var(--accent); }

    .switch { position: relative; display: inline-block; width: 50px; height: 26px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--bg-secondary); transition: 0.3s; border-radius: 26px; border: 1px solid var(--border); }
    .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: var(--text-secondary); transition: 0.3s; border-radius: 50%; }
    input:checked + .slider { background-color: var(--accent); border-color: var(--accent); }
    input:checked + .slider:before { transform: translateX(24px); background-color: white; }

    .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
    .info-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border); }
    .info-label { color: var(--text-secondary); font-size: 13px; }
    .info-value { font-weight: 500; text-align: right; word-break: break-all; max-width: 60%; }

    .code-block { background: var(--bg-primary); border-radius: 10px; padding: 20px; font-family: 'Consolas', 'Monaco', monospace; font-size: 13px; overflow-x: auto; border: 1px solid var(--border); position: relative; }
    .copy-btn { position: absolute; top: 10px; right: 10px; padding: 8px 15px; background: var(--accent); color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12px; }

    .pagination { display: flex; justify-content: center; gap: 8px; margin-top: 20px; }
    .page-btn { padding: 8px 14px; border-radius: 8px; background: var(--bg-secondary); border: 1px solid var(--border); color: var(--text-primary); cursor: pointer; font-size: 13px; }
    .page-btn:hover, .page-btn.active { background: var(--accent); border-color: var(--accent); }
    .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }

    .loading { display: flex; align-items: center; justify-content: center; padding: 50px; }
    .spinner { width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .section { display: none; }
    .section.active { display: block; }

    .period-selector { display: flex; gap: 5px; background: var(--bg-secondary); padding: 5px; border-radius: 10px; }
    .period-btn { padding: 8px 12px; border: none; background: none; color: var(--text-secondary); border-radius: 8px; cursor: pointer; font-size: 12px; }
    .period-btn.active { background: var(--accent); color: white; }

    .site-selector { min-width: 200px; }

    .site-card { background: var(--bg-secondary); border-radius: 12px; padding: 20px; border: 1px solid var(--border); margin-bottom: 15px; }
    .site-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .site-card-title { font-size: 16px; font-weight: 600; }
    .site-card-domain { color: var(--text-secondary); font-size: 13px; }
    .site-card-stats { display: flex; gap: 20px; margin-top: 10px; }
    .site-card-stat { text-align: center; }
    .site-card-stat-value { font-size: 20px; font-weight: 700; }
    .site-card-stat-label { font-size: 11px; color: var(--text-secondary); }

    .empty-state { text-align: center; padding: 60px 20px; color: var(--text-secondary); }
    .empty-state i { font-size: 60px; margin-bottom: 20px; opacity: 0.5; }
    .empty-state h3 { margin-bottom: 10px; color: var(--text-primary); }

    @media (max-width: 768px) {
      .sidebar { transform: translateX(-100%); }
      .main { margin-left: 0; }
      .charts-grid { grid-template-columns: 1fr; }
      .header { flex-direction: column; align-items: flex-start; }
    }
  </style>
</head>
<body>
  <aside class="sidebar">
    <div class="logo">
      <i class="ri-shield-keyhole-fill"></i>
      <h1>Cloaker Pro</h1>
    </div>
    <ul class="nav-menu">
      <li class="nav-item"><a class="nav-link active" data-section="dashboard"><i class="ri-dashboard-3-line"></i> Dashboard</a></li>
      <li class="nav-item"><a class="nav-link" data-section="sites"><i class="ri-global-line"></i> Meus Sites</a></li>
      <li class="nav-item"><a class="nav-link" data-section="visitors"><i class="ri-user-line"></i> Visitantes</a></li>
      <li class="nav-item"><a class="nav-link" data-section="reports"><i class="ri-file-list-3-line"></i> Permitidos e Bloqueados</a></li>
      <li class="nav-item"><a class="nav-link" data-section="script"><i class="ri-link"></i> Link para Ads</a></li>
    </ul>
  </aside>

  <main class="main">
    <!-- Dashboard -->
    <section id="dashboard" class="section active">
      <div class="header">
        <div>
          <h2>Dashboard</h2>
          <p style="color: var(--text-secondary); font-size: 13px; margin-top: 4px;">Hor√°rio de Bras√≠lia (BRT) ¬∑ Atualiza√ß√£o autom√°tica a cada 30s</p>
        </div>
        <div class="header-actions">
          <select class="form-select site-selector" id="dashboardSiteFilter" onchange="refreshStats()">
            <option value="all">Todos os Sites</option>
          </select>
          <div class="period-selector">
            <button class="period-btn" data-period="1h">1h</button>
            <button class="period-btn active" data-period="24h">24h</button>
            <button class="period-btn" data-period="7d">7d</button>
            <button class="period-btn" data-period="30d">30d</button>
          </div>
          <button class="btn btn-primary" onclick="refreshStats(); loadLastVisits();"><i class="ri-refresh-line"></i> Atualizar</button>
        </div>
      </div>

      <div class="stats-grid">
        <div class="stat-card"><div class="stat-icon"><i class="ri-eye-line"></i></div><div class="stat-value" id="statTotal">-</div><div class="stat-label">Total de Visitas</div></div>
        <div class="stat-card success"><div class="stat-icon"><i class="ri-check-line"></i></div><div class="stat-value" id="statAllowed">-</div><div class="stat-label">Permitidos</div></div>
        <div class="stat-card danger"><div class="stat-icon"><i class="ri-forbid-line"></i></div><div class="stat-value" id="statBlocked">-</div><div class="stat-label">Bloqueados</div></div>
        <div class="stat-card warning"><div class="stat-icon"><i class="ri-robot-line"></i></div><div class="stat-value" id="statBots">-</div><div class="stat-label">Bots</div></div>
        <div class="stat-card"><div class="stat-icon"><i class="ri-smartphone-line"></i></div><div class="stat-value" id="statMobile">-</div><div class="stat-label">Mobile</div></div>
        <div class="stat-card"><div class="stat-icon"><i class="ri-computer-line"></i></div><div class="stat-value" id="statDesktop">-</div><div class="stat-label">Desktop</div></div>
      </div>

      <div class="charts-grid">
        <div class="card"><div class="card-header"><h3 class="card-title"><i class="ri-line-chart-line"></i> Visitas por Hora</h3></div><div class="card-body"><div class="chart-container"><canvas id="chartHourly"></canvas></div></div></div>
        <div class="card"><div class="card-header"><h3 class="card-title"><i class="ri-pie-chart-line"></i> Por Navegador</h3></div><div class="card-body"><div class="chart-container"><canvas id="chartBrowser"></canvas></div></div></div>
      </div>
      <div class="charts-grid">
        <div class="card"><div class="card-header"><h3 class="card-title"><i class="ri-global-line"></i> Por Pa√≠s</h3></div><div class="card-body"><div class="chart-container"><canvas id="chartCountry"></canvas></div></div></div>
        <div class="card"><div class="card-header"><h3 class="card-title"><i class="ri-prohibited-line"></i> Motivos de Bloqueio</h3></div><div class="card-body"><div class="chart-container"><canvas id="chartBlockReasons"></canvas></div></div></div>
      </div>

      <div class="card">
        <div class="card-header">
          <h3 class="card-title"><i class="ri-time-line"></i> √öltimos acessos (hor√°rio Bras√≠lia)</h3>
          <a href="#" class="btn btn-secondary btn-sm" onclick="document.querySelector('[data-section=visitors]').click(); return false;">Ver todos</a>
        </div>
        <div class="card-body">
          <div class="table-container">
            <table>
              <thead><tr><th>Data/Hora (BRT)</th><th>IP</th><th>Site</th><th>Status</th><th>Pa√≠s</th><th>Dispositivo</th><th>Motivo</th><th>A√ß√µes</th></tr></thead>
              <tbody id="lastVisitsTable"><tr><td colspan="8" class="loading"><div class="spinner"></div></td></tr></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- Sites -->
    <section id="sites" class="section">
      <div class="header">
        <h2>Meus Sites</h2>
        <button class="btn btn-primary" onclick="openNewSiteModal()"><i class="ri-add-line"></i> Novo Site</button>
      </div>
      <div id="sitesList"></div>
    </section>

    <!-- Visitors -->
    <section id="visitors" class="section">
      <div class="header">
        <h2>Visitantes</h2>
        <div class="header-actions">
          <select class="form-select site-selector" id="visitorsSiteFilter" onchange="loadVisitors()">
            <option value="all">Todos os Sites</option>
          </select>
          <div class="filters">
            <button class="filter-btn active" data-filter="all">Todos</button>
            <button class="filter-btn" data-filter="allowed">Permitidos</button>
            <button class="filter-btn" data-filter="blocked">Bloqueados</button>
            <button class="filter-btn" data-filter="bots">Bots</button>
            <button class="filter-btn" data-filter="mobile">Mobile</button>
          </div>
          <button class="btn btn-secondary" onclick="exportData('csv')"><i class="ri-download-line"></i> Exportar</button>
        </div>
      </div>
      <div class="card"><div class="card-body">
        <div class="table-container">
          <table>
            <thead><tr><th>Data</th><th>IP</th><th>Site</th><th>Status</th><th>Pa√≠s</th><th>Dispositivo</th><th>Navegador</th><th>A√ß√µes</th></tr></thead>
            <tbody id="visitorsTable"><tr><td colspan="8" class="loading"><div class="spinner"></div></td></tr></tbody>
          </table>
        </div>
        <div class="pagination" id="pagination"></div>
      </div></div>
    </section>

    <!-- Permitidos e Bloqueados -->
    <section id="reports" class="section">
      <div class="header">
        <h2>Permitidos e Bloqueados</h2>
        <div class="header-actions">
          <select class="form-select site-selector" id="reportsSiteFilter" onchange="loadReports()">
            <option value="all">Todos os Sites</option>
          </select>
          <button class="btn btn-primary" onclick="loadReports()"><i class="ri-refresh-line"></i> Atualizar</button>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h3 class="card-title"><i class="ri-check-line" style="color:var(--success)"></i> Visitantes Permitidos (com UTMs e origem)</h3>
        </div>
        <div class="card-body">
          <div class="table-container">
            <table>
              <thead><tr><th>Data</th><th>Site</th><th>Pa√≠s</th><th>Dispositivo</th><th>UTM Source</th><th>UTM Medium</th><th>UTM Campaign</th><th>Referrer</th><th>A√ß√µes</th></tr></thead>
              <tbody id="permittedTable"><tr><td colspan="9" class="loading"><div class="spinner"></div></td></tr></tbody>
            </table>
          </div>
          <div class="pagination" id="permittedPagination"></div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h3 class="card-title"><i class="ri-forbid-line" style="color:var(--danger)"></i> Visitantes Bloqueados</h3>
        </div>
        <div class="card-body">
          <div class="table-container">
            <table>
              <thead><tr><th>Data</th><th>Site</th><th>Pa√≠s</th><th>Motivo do bloqueio</th><th>Dispositivo</th><th>Navegador</th><th>A√ß√µes</th></tr></thead>
              <tbody id="blockedTable"><tr><td colspan="7" class="loading"><div class="spinner"></div></td></tr></tbody>
            </table>
          </div>
          <div class="pagination" id="blockedPagination"></div>
        </div>
      </div>
    </section>

    <!-- Script/Integra√ß√£o -->
    <section id="script" class="section">
      <div class="header">
        <h2>Link para Ads</h2>
      </div>
      <!-- Gerar link direto: colar URL ‚Üí gerar link para usar nos Ads -->
      <div class="card" style="border: 2px solid var(--accent);">
        <div class="card-header"><h3 class="card-title"><i class="ri-links-line"></i> Gerar novo link para Ads</h3></div>
        <div class="card-body">
          <p style="color: var(--text-secondary); margin-bottom: 15px;">Cole o link da sua landing page abaixo e clique em <strong>Gerar link</strong>. Use o link gerado como <strong>URL de destino</strong> nos seus an√∫ncios (Meta Ads, Google Ads, etc.).</p>
          <div class="form-group">
            <label class="form-label">URL da sua landing page</label>
            <input type="url" class="form-input" id="quickTargetUrl" placeholder="https://seusite.com/landing">
          </div>
          <div class="form-group">
            <label class="form-label">Nome (opcional ‚Äì para identificar no painel)</label>
            <input type="text" class="form-input" id="quickSiteName" placeholder="Ex: Campanha Janeiro">
          </div>
          <button class="btn btn-primary" onclick="generateLinkFromUrl()"><i class="ri-link"></i> Gerar link para Ads</button>
          <div id="generatedLinkBox" style="display: none; margin-top: 20px; padding: 20px; background: var(--bg-secondary); border-radius: 10px; border: 1px solid var(--success);">
            <div class="form-label" style="margin-bottom: 8px;">‚úÖ Link gerado ‚Äì use esse link nos seus an√∫ncios:</div>
            <div class="code-block" style="margin-bottom: 10px;">
              <button class="copy-btn" id="copyGeneratedLinkBtn" onclick="copyToClipboard(document.getElementById('generatedLinkText').textContent)"><i class="ri-file-copy-line"></i> Copiar</button>
              <pre id="generatedLinkText"></pre>
            </div>
            <p style="color: var(--text-secondary); font-size: 12px;">N√£o precisa colocar nenhum script no seu site. S√≥ use esse link como URL de destino nos Ads.</p>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="card-header"><h3 class="card-title"><i class="ri-information-line"></i> Como funciona</h3></div>
        <div class="card-body">
          <p style="margin-bottom: 20px; line-height: 1.8;">
            <strong>1.</strong> Em "Meus Sites", cadastre seu site e coloque a <strong>URL da sua landing page</strong> (o link real do seu site).<br>
            <strong>2.</strong> O sistema gera um <strong>novo link</strong> para voc√™ (ex: <code>https://seu-painel.up.railway.app/go/abc12xyz</code>).<br>
            <strong>3.</strong> Use esse novo link como <strong>URL de destino</strong> nos seus an√∫ncios (Meta Ads, Google Ads, etc.).<br>
            <strong>4.</strong> Quem clicar no an√∫ncio passa primeiro pelo nosso servidor: se for permitido (ex: mobile, Brasil), vai para seu site; se for bloqueado (desktop, bot, etc.), vai para a URL de redirecionamento (ex: Google).
          </p>
          <div style="background: var(--bg-secondary); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
            <h4 style="margin-bottom: 10px;">üìå Importante</h4>
            <ul style="color: var(--text-secondary); line-height: 1.8; padding-left: 20px;">
              <li><strong>N√£o precisa colocar nenhum script no seu site.</strong> S√≥ usar o link gerado nos Ads.</li>
              <li>Cada site tem seu pr√≥prio link e configura√ß√µes (pa√≠s, bloqueio de desktop, etc.).</li>
              <li>Os par√¢metros do an√∫ncio (UTM, fbclid, etc.) s√£o repassados para sua landing page.</li>
              <li>Todos os acessos (permitidos e bloqueados) aparecem no painel.</li>
            </ul>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="card-header"><h3 class="card-title"><i class="ri-link"></i> Seu link para usar nos Ads</h3></div>
        <div class="card-body">
          <p style="margin-bottom: 15px; color: var(--text-secondary);">Selecione um site para ver e copiar o link:</p>
          <select class="form-select" id="scriptSiteSelector" style="max-width: 300px; margin-bottom: 20px;" onchange="updateScriptCode()">
            <option value="">Selecione um site...</option>
          </select>
          <div class="code-block" id="scriptCodeBlock" style="display: none;">
            <button class="copy-btn" onclick="copyScript()"><i class="ri-file-copy-line"></i> Copiar link</button>
            <pre id="scriptCode"></pre>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Modal Novo/Editar Site -->
  <div class="modal" id="siteModal">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h3 id="siteModalTitle">Novo Site</h3>
        <button class="modal-close" onclick="closeSiteModal()">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="editSiteId">
        <div class="form-group">
          <label class="form-label">Nome do Site</label>
          <input type="text" class="form-input" id="siteName" placeholder="Ex: Landing Page Produto X">
        </div>
        <div class="form-group">
          <label class="form-label">URL do seu site (landing page)</label>
          <input type="url" class="form-input" id="siteTargetUrl" placeholder="https://meusite.com/landing" required>
          <small style="color: var(--text-secondary); font-size: 12px;">Link real da sua p√°gina. Quem for permitido vai para esse link.</small>
        </div>
        <div class="form-group">
          <label class="form-label">Dom√≠nio (opcional)</label>
          <input type="text" class="form-input" id="siteDomain" placeholder="Ex: meuproduto.com">
        </div>
        <div class="form-group">
          <label class="form-label">URL de Redirecionamento (quando bloquear)</label>
          <input type="text" class="form-input" id="siteRedirectUrl" value="https://www.google.com/" placeholder="Para onde mandar quem for bloqueado">
        </div>
        <h4 style="margin: 25px 0 15px;">Regras de Bloqueio</h4>
        <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 15px;">Padr√£o: <strong>apenas Brasil (BR)</strong>; bloquear desktops, Facebook, bots, VPN/proxy e DevTools.</p>
        <div class="info-grid">
          <div class="info-item"><span class="info-label">Bloquear Desktops</span><label class="switch"><input type="checkbox" id="siteBlockDesktop" checked><span class="slider"></span></label></div>
          <div class="info-item"><span class="info-label">Bloquear Biblioteca Facebook</span><label class="switch"><input type="checkbox" id="siteBlockFacebook" checked><span class="slider"></span></label></div>
          <div class="info-item"><span class="info-label">Bloquear Bots</span><label class="switch"><input type="checkbox" id="siteBlockBots" checked><span class="slider"></span></label></div>
          <div class="info-item"><span class="info-label">Bloquear VPN/Proxy</span><label class="switch"><input type="checkbox" id="siteBlockVpn" checked><span class="slider"></span></label></div>
          <div class="info-item"><span class="info-label">Bloquear DevTools</span><label class="switch"><input type="checkbox" id="siteBlockDevtools" checked><span class="slider"></span></label></div>
        </div>
        <div class="form-group" style="margin-top: 20px;">
          <label class="form-label">Pa√≠ses Permitidos (padr√£o: apenas BR ‚Äì Brasil)</label>
          <input type="text" class="form-input" id="siteAllowedCountries" placeholder="BR" value="BR">
        </div>
        <div class="form-group">
          <label class="form-label">Pa√≠ses Bloqueados (ex: US,UK ‚Äì vazio = nenhum)</label>
          <input type="text" class="form-input" id="siteBlockedCountries" placeholder="Deixe vazio para n√£o bloquear">
        </div>
        <div style="display: flex; gap: 10px; margin-top: 25px;">
          <button class="btn btn-primary" onclick="saveSite()"><i class="ri-save-line"></i> Salvar</button>
          <button class="btn btn-secondary" onclick="closeSiteModal()">Cancelar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Detalhes Visitante -->
  <div class="modal" id="visitorModal">
    <div class="modal-content">
      <div class="modal-header"><h3>Detalhes do Visitante</h3><button class="modal-close" onclick="closeVisitorModal()">&times;</button></div>
      <div class="modal-body" id="visitorDetails"><div class="loading"><div class="spinner"></div></div></div>
    </div>
  </div>

  <script>
    let currentPeriod = '24h';
    let currentFilter = 'all';
    let currentPage = 1;
    let permittedPage = 1;
    let blockedPage = 1;
    let charts = {};
    let sites = [];

    // Hor√°rio de Bras√≠lia (America/Sao_Paulo) ‚Äì datas da API s√£o tratadas como UTC
    const TZ_BR = 'America/Sao_Paulo';
    function toDateBR(d) {
      if (!d) return null;
      var s = typeof d === 'string' ? d : d;
      if (typeof s === 'string' && !/Z|[+-]\d{2}:?\d{2}$/.test(s)) s = s.replace(' ', 'T') + 'Z';
      return new Date(s);
    }
    function formatDateBR(d) {
      var date = toDateBR(d);
      return date ? date.toLocaleString('pt-BR', { timeZone: TZ_BR, dateStyle: 'short', timeStyle: 'short' }) : '-';
    }
    function formatDateTimeBR(d) {
      var date = toDateBR(d);
      return date ? date.toLocaleString('pt-BR', { timeZone: TZ_BR, day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' }) : '-';
    }

    // Navigation
    document.querySelectorAll('.nav-link').forEach(link => {
      link.addEventListener('click', () => {
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        link.classList.add('active');
        const section = link.dataset.section;
        document.getElementById(section).classList.add('active');
        if (section === 'dashboard') refreshStats();
        if (section === 'sites') loadSites();
        if (section === 'visitors') loadVisitors();
        if (section === 'reports') loadReports();
        if (section === 'script') loadScriptSection();
      });
    });

    document.querySelectorAll('.period-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentPeriod = btn.dataset.period;
        refreshStats();
      });
    });

    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentFilter = btn.dataset.filter;
        currentPage = 1;
        loadVisitors();
      });
    });

    // Sites
    async function loadSites() {
      try {
        const res = await fetch('/api/sites');
        sites = await res.json();
        updateSiteSelectors();
        renderSitesList();
      } catch (e) { console.error(e); }
    }

    function updateSiteSelectors() {
      const selectors = ['dashboardSiteFilter', 'visitorsSiteFilter', 'reportsSiteFilter', 'scriptSiteSelector'];
      selectors.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        const currentVal = el.value;
        if (id === 'scriptSiteSelector') {
          el.innerHTML = '<option value="">Selecione um site...</option>' + sites.map(s => `<option value="${s.site_id}">${s.name}</option>`).join('');
        } else {
          el.innerHTML = '<option value="all">Todos os Sites</option>' + sites.map(s => `<option value="${s.site_id}">${s.name}</option>`).join('');
        }
        el.value = currentVal || (id === 'scriptSiteSelector' ? '' : 'all');
      });
    }

    function renderSitesList() {
      const container = document.getElementById('sitesList');
      if (sites.length === 0) {
        container.innerHTML = `<div class="empty-state"><i class="ri-global-line"></i><h3>Nenhum site cadastrado</h3><p>Clique em "Novo Site" para come√ßar</p></div>`;
        return;
      }
      container.innerHTML = sites.map(s => `
        <div class="site-card">
          <div class="site-card-header">
            <div>
              <div class="site-card-title">${s.name}</div>
              <div class="site-card-domain">${s.domain || 'Sem dom√≠nio'}</div>
            </div>
            <div style="display: flex; gap: 10px;">
              <button class="btn btn-secondary btn-sm" onclick="editSite('${s.site_id}')"><i class="ri-edit-line"></i></button>
              <button class="btn btn-danger btn-sm" onclick="deleteSite('${s.site_id}')"><i class="ri-delete-bin-line"></i></button>
            </div>
          </div>
          <div class="site-card-stats">
            <div class="site-card-stat"><div class="site-card-stat-value">${s.total_visits || 0}</div><div class="site-card-stat-label">Visitas</div></div>
            <div class="site-card-stat"><div class="site-card-stat-value" style="color: var(--danger)">${s.blocked_visits || 0}</div><div class="site-card-stat-label">Bloqueados</div></div>
            <div class="site-card-stat"><div class="site-card-stat-value" style="color: var(--success)">${(s.total_visits || 0) - (s.blocked_visits || 0)}</div><div class="site-card-stat-label">Permitidos</div></div>
          </div>
          <div style="margin-top: 15px;">
            <div class="form-label" style="margin-bottom: 6px;">üîó Link para usar nos Ads (Meta Ads, etc.)</div>
            <div class="code-block" style="font-size: 12px; padding: 10px;">
              <button class="copy-btn" style="padding: 4px 8px; font-size: 10px;" onclick="if ('${s.link_code || ''}') copyToClipboard('${window.location.origin}/go/${s.link_code || ''}'); else alert('Edite o site e salve a URL do seu site para gerar o link.');"><i class="ri-file-copy-line"></i></button>
              ${s.link_code ? (window.location.origin + '/go/' + s.link_code) : 'Salve a URL do seu site e edite o site para gerar o link.'}
            </div>
            <p style="color: var(--text-secondary); font-size: 12px; margin-top: 8px;">Use esse link como <strong>URL de destino</strong> nos seus an√∫ncios. N√£o precisa colocar script no seu site.</p>
          </div>
        </div>
      `).join('');
    }

    function openNewSiteModal() {
      document.getElementById('siteModalTitle').textContent = 'Novo Site';
      document.getElementById('editSiteId').value = '';
      document.getElementById('siteName').value = '';
      document.getElementById('siteDomain').value = '';
      document.getElementById('siteTargetUrl').value = '';
      document.getElementById('siteRedirectUrl').value = 'https://www.google.com/';
      document.getElementById('siteBlockDesktop').checked = true;
      document.getElementById('siteBlockFacebook').checked = true;
      document.getElementById('siteBlockBots').checked = true;
      document.getElementById('siteBlockVpn').checked = true;
      document.getElementById('siteBlockDevtools').checked = true;
      document.getElementById('siteAllowedCountries').value = 'BR';
      document.getElementById('siteBlockedCountries').value = '';
      document.getElementById('siteModal').classList.add('active');
    }

    function editSite(siteId) {
      const site = sites.find(s => s.site_id === siteId);
      if (!site) return;
      document.getElementById('siteModalTitle').textContent = 'Editar Site';
      document.getElementById('editSiteId').value = siteId;
      document.getElementById('siteName').value = site.name;
      document.getElementById('siteDomain').value = site.domain || '';
      document.getElementById('siteTargetUrl').value = site.target_url || '';
      document.getElementById('siteRedirectUrl').value = site.redirect_url || 'https://www.google.com/';
      document.getElementById('siteBlockDesktop').checked = site.block_desktop;
      document.getElementById('siteBlockFacebook').checked = site.block_facebook_library;
      document.getElementById('siteBlockBots').checked = site.block_bots;
      document.getElementById('siteBlockVpn').checked = site.block_vpn;
      document.getElementById('siteBlockDevtools').checked = site.block_devtools;
      document.getElementById('siteAllowedCountries').value = site.allowed_countries || 'BR';
      document.getElementById('siteBlockedCountries').value = site.blocked_countries || '';
      document.getElementById('siteModal').classList.add('active');
    }

    async function saveSite() {
      const siteId = document.getElementById('editSiteId').value;
      const data = {
        name: document.getElementById('siteName').value,
        domain: document.getElementById('siteDomain').value,
        target_url: document.getElementById('siteTargetUrl').value,
        redirect_url: document.getElementById('siteRedirectUrl').value,
        block_desktop: document.getElementById('siteBlockDesktop').checked,
        block_facebook_library: document.getElementById('siteBlockFacebook').checked,
        block_bots: document.getElementById('siteBlockBots').checked,
        block_devtools: document.getElementById('siteBlockDevtools').checked,
        block_vpn: document.getElementById('siteBlockVpn').checked,
        allowed_countries: document.getElementById('siteAllowedCountries').value,
        blocked_countries: document.getElementById('siteBlockedCountries').value,
        is_active: true
      };
      
      if (!data.name) { alert('Digite um nome para o site'); return; }
      if (!data.target_url || !data.target_url.trim()) { alert('Digite a URL do seu site (landing page)'); return; }
      
      try {
        if (siteId) {
          await fetch(`/api/sites/${siteId}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
        } else {
          await fetch('/api/sites', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
        }
        closeSiteModal();
        loadSites();
      } catch (e) { alert('Erro ao salvar site'); }
    }

    async function deleteSite(siteId) {
      if (!confirm('Tem certeza? Todos os dados de visitantes deste site ser√£o perdidos!')) return;
      try {
        await fetch(`/api/sites/${siteId}`, { method: 'DELETE' });
        loadSites();
      } catch (e) { alert('Erro ao deletar site'); }
    }

    function closeSiteModal() { document.getElementById('siteModal').classList.remove('active'); }

    // Stats
    async function refreshStats() {
      const siteId = document.getElementById('dashboardSiteFilter').value;
      try {
        const res = await fetch(`/api/stats?period=${currentPeriod}&site=${siteId}`);
        const stats = await res.json();
        document.getElementById('statTotal').textContent = stats.total.toLocaleString();
        document.getElementById('statAllowed').textContent = stats.allowed.toLocaleString();
        document.getElementById('statBlocked').textContent = stats.blocked.toLocaleString();
        document.getElementById('statBots').textContent = stats.bots.toLocaleString();
        document.getElementById('statMobile').textContent = stats.mobile.toLocaleString();
        document.getElementById('statDesktop').textContent = stats.desktop.toLocaleString();
        updateCharts(stats);
        loadLastVisits();
      } catch (e) { console.error(e); }
    }

    async function loadLastVisits() {
      const siteId = document.getElementById('dashboardSiteFilter').value;
      const tbody = document.getElementById('lastVisitsTable');
      if (!tbody) return;
      try {
        const res = await fetch(`/api/visitors?page=1&limit=10&filter=all&site=${siteId}`);
        const data = await res.json();
        if (data.visitors.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:30px;color:var(--text-secondary)">Nenhum acesso ainda</td></tr>';
          return;
        }
        tbody.innerHTML = data.visitors.map(v => `
          <tr>
            <td>${formatDateTimeBR(v.created_at)}</td>
            <td><code style="font-size:11px">${v.ip || '-'}</code></td>
            <td><span class="badge badge-info">${v.site_id || 'default'}</span></td>
            <td>${v.was_blocked ? '<span class="badge badge-danger">Bloqueado</span>' : '<span class="badge badge-success">Permitido</span>'}</td>
            <td>${v.country || '-'}</td>
            <td><i class="ri-${v.device_type === 'mobile' ? 'smartphone' : 'computer'}-line"></i> ${v.device_type || 'desktop'}</td>
            <td title="${(v.block_reason || '').replace(/"/g, '')}">${v.block_reason ? (v.block_reason.length > 25 ? v.block_reason.substring(0, 25) + '...' : v.block_reason) : '-'}</td>
            <td><button class="btn btn-secondary btn-sm" onclick="viewVisitor(${v.id})"><i class="ri-eye-line"></i></button></td>
          </tr>
        `).join('');
      } catch (e) { tbody.innerHTML = '<tr><td colspan="8" style="color:var(--danger)">Erro ao carregar</td></tr>'; }
    }

    function updateCharts(stats) {
      const colors = { line: ['#00d9a5', '#e94560'], pie: ['#e94560', '#00d9a5', '#ffc107', '#17a2b8', '#6f42c1', '#fd7e14'] };
      const chartOpts = { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: '#a0a0b0' } } } };
      
      // Hourly
      const hourlyData = stats.byHour.reverse();
      if (charts.hourly) charts.hourly.destroy();
      charts.hourly = new Chart(document.getElementById('chartHourly'), {
        type: 'line',
        data: {
          labels: hourlyData.map(h => h.hour?.split(' ')[1] || h.hour),
          datasets: [
            { label: 'Permitidos', data: hourlyData.map(h => h.allowed), borderColor: colors.line[0], backgroundColor: 'rgba(0,217,165,0.1)', fill: true, tension: 0.4 },
            { label: 'Bloqueados', data: hourlyData.map(h => h.blocked), borderColor: colors.line[1], backgroundColor: 'rgba(233,69,96,0.1)', fill: true, tension: 0.4 }
          ]
        },
        options: { ...chartOpts, scales: { x: { ticks: { color: '#a0a0b0' }, grid: { color: '#2a2a4a' } }, y: { ticks: { color: '#a0a0b0' }, grid: { color: '#2a2a4a' } } } }
      });

      // Browser
      if (charts.browser) charts.browser.destroy();
      charts.browser = new Chart(document.getElementById('chartBrowser'), {
        type: 'doughnut',
        data: { labels: stats.byBrowser.map(b => b.browser || 'N/A'), datasets: [{ data: stats.byBrowser.map(b => b.count), backgroundColor: colors.pie }] },
        options: { ...chartOpts, plugins: { legend: { position: 'right', labels: { color: '#a0a0b0' } } } }
      });

      // Country
      if (charts.country) charts.country.destroy();
      charts.country = new Chart(document.getElementById('chartCountry'), {
        type: 'bar',
        data: { labels: stats.byCountry.map(c => c.country || 'N/A'), datasets: [{ label: 'Visitas', data: stats.byCountry.map(c => c.count), backgroundColor: '#e94560' }] },
        options: { ...chartOpts, plugins: { legend: { display: false } }, scales: { x: { ticks: { color: '#a0a0b0' }, grid: { color: '#2a2a4a' } }, y: { ticks: { color: '#a0a0b0' }, grid: { color: '#2a2a4a' } } } }
      });

      // Block Reasons
      if (charts.blockReasons) charts.blockReasons.destroy();
      charts.blockReasons = new Chart(document.getElementById('chartBlockReasons'), {
        type: 'pie',
        data: { labels: stats.blockReasons.map(r => r.block_reason || 'Outro'), datasets: [{ data: stats.blockReasons.map(r => r.count), backgroundColor: colors.pie }] },
        options: { ...chartOpts, plugins: { legend: { position: 'right', labels: { color: '#a0a0b0' } } } }
      });
    }

    // Visitors
    async function loadVisitors() {
      const siteId = document.getElementById('visitorsSiteFilter').value;
      const tbody = document.getElementById('visitorsTable');
      tbody.innerHTML = '<tr><td colspan="8" class="loading"><div class="spinner"></div></td></tr>';
      try {
        const res = await fetch(`/api/visitors?page=${currentPage}&filter=${currentFilter}&site=${siteId}`);
        const data = await res.json();
        if (data.visitors.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:40px;color:var(--text-secondary)">Nenhum visitante encontrado</td></tr>';
          document.getElementById('pagination').innerHTML = '';
          return;
        }
        tbody.innerHTML = data.visitors.map(v => `
          <tr>
            <td>${formatDateBR(v.created_at)}</td>
            <td><code style="font-size:11px">${v.ip || '-'}</code></td>
            <td><span class="badge badge-info">${v.site_id || 'default'}</span></td>
            <td>${v.was_blocked ? '<span class="badge badge-danger"><i class="ri-close-line"></i> Bloqueado</span>' : '<span class="badge badge-success"><i class="ri-check-line"></i> OK</span>'}${v.is_bot ? ' <span class="badge badge-warning">Bot</span>' : ''}</td>
            <td>${v.country || '-'}</td>
            <td><i class="ri-${v.device_type === 'mobile' ? 'smartphone' : 'computer'}-line"></i> ${v.device_type || 'desktop'}</td>
            <td>${v.browser || '-'}</td>
            <td><button class="btn btn-secondary btn-sm" onclick="viewVisitor(${v.id})"><i class="ri-eye-line"></i></button></td>
          </tr>
        `).join('');
        
        let pag = '';
        if (data.pages > 1) {
          pag = `<button class="page-btn" ${currentPage <= 1 ? 'disabled' : ''} onclick="goToPage(${currentPage - 1})"><i class="ri-arrow-left-line"></i></button>`;
          for (let i = 1; i <= data.pages; i++) {
            if (i === 1 || i === data.pages || (i >= currentPage - 2 && i <= currentPage + 2)) {
              pag += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
            } else if (i === currentPage - 3 || i === currentPage + 3) pag += '<span style="color:var(--text-secondary)">...</span>';
          }
          pag += `<button class="page-btn" ${currentPage >= data.pages ? 'disabled' : ''} onclick="goToPage(${currentPage + 1})"><i class="ri-arrow-right-line"></i></button>`;
        }
        document.getElementById('pagination').innerHTML = pag;
      } catch (e) { console.error(e); tbody.innerHTML = '<tr><td colspan="8" style="color:var(--danger)">Erro ao carregar</td></tr>'; }
    }

    function goToPage(p) { currentPage = p; loadVisitors(); }

    // Relat√≥rio Permitidos e Bloqueados
    async function loadReports() {
      loadPermitted();
      loadBlocked();
    }

    async function loadPermitted() {
      const siteId = document.getElementById('reportsSiteFilter').value;
      const tbody = document.getElementById('permittedTable');
      tbody.innerHTML = '<tr><td colspan="9" class="loading"><div class="spinner"></div></td></tr>';
      try {
        const res = await fetch(`/api/visitors?page=${permittedPage}&filter=allowed&site=${siteId}&limit=25`);
        const data = await res.json();
        if (data.visitors.length === 0) {
          tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:40px;color:var(--text-secondary)">Nenhum visitante permitido</td></tr>';
          document.getElementById('permittedPagination').innerHTML = '';
          return;
        }
        tbody.innerHTML = data.visitors.map(v => `
          <tr>
            <td>${formatDateBR(v.created_at)}</td>
            <td><span class="badge badge-info">${v.site_id || 'default'}</span></td>
            <td>${v.country || '-'}</td>
            <td><i class="ri-${v.device_type === 'mobile' ? 'smartphone' : 'computer'}-line"></i> ${v.device_type || 'desktop'}</td>
            <td>${v.utm_source || '-'}</td>
            <td>${v.utm_medium || '-'}</td>
            <td>${v.utm_campaign || '-'}</td>
            <td title="${(v.referrer || '').replace(/"/g, '')}">${v.referrer ? (v.referrer.length > 40 ? v.referrer.substring(0, 40) + '...' : v.referrer) : '-'}</td>
            <td><button class="btn btn-secondary btn-sm" onclick="viewVisitor(${v.id})"><i class="ri-eye-line"></i></button></td>
          </tr>
        `).join('');
        let pag = '';
        if (data.pages > 1) {
          pag = `<button class="page-btn" ${permittedPage <= 1 ? 'disabled' : ''} onclick="permittedPage=${permittedPage-1};loadPermitted()"><i class="ri-arrow-left-line"></i></button>`;
          for (let i = 1; i <= data.pages; i++) {
            if (i === 1 || i === data.pages || (i >= permittedPage - 2 && i <= permittedPage + 2)) {
              pag += `<button class="page-btn ${i === permittedPage ? 'active' : ''}" onclick="permittedPage=${i};loadPermitted()">${i}</button>`;
            } else if (i === permittedPage - 3 || i === permittedPage + 3) pag += '<span style="color:var(--text-secondary)">...</span>';
          }
          pag += `<button class="page-btn" ${permittedPage >= data.pages ? 'disabled' : ''} onclick="permittedPage=${permittedPage+1};loadPermitted()"><i class="ri-arrow-right-line"></i></button>`;
        }
        document.getElementById('permittedPagination').innerHTML = pag;
      } catch (e) { console.error(e); tbody.innerHTML = '<tr><td colspan="9" style="color:var(--danger)">Erro ao carregar</td></tr>'; }
    }

    async function loadBlocked() {
      const siteId = document.getElementById('reportsSiteFilter').value;
      const tbody = document.getElementById('blockedTable');
      tbody.innerHTML = '<tr><td colspan="7" class="loading"><div class="spinner"></div></td></tr>';
      try {
        const res = await fetch(`/api/visitors?page=${blockedPage}&filter=blocked&site=${siteId}&limit=25`);
        const data = await res.json();
        if (data.visitors.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:40px;color:var(--text-secondary)">Nenhum visitante bloqueado</td></tr>';
          document.getElementById('blockedPagination').innerHTML = '';
          return;
        }
        tbody.innerHTML = data.visitors.map(v => `
          <tr>
            <td>${formatDateBR(v.created_at)}</td>
            <td><span class="badge badge-info">${v.site_id || 'default'}</span></td>
            <td>${v.country || '-'}</td>
            <td><span class="badge badge-danger" title="${(v.block_reason || '').replace(/"/g, '')}">${v.block_reason ? (v.block_reason.length > 35 ? v.block_reason.substring(0, 35) + '...' : v.block_reason) : '-'}</span></td>
            <td><i class="ri-${v.device_type === 'mobile' ? 'smartphone' : 'computer'}-line"></i> ${v.device_type || 'desktop'}</td>
            <td>${v.browser || '-'}</td>
            <td><button class="btn btn-secondary btn-sm" onclick="viewVisitor(${v.id})"><i class="ri-eye-line"></i></button></td>
          </tr>
        `).join('');
        let pag = '';
        if (data.pages > 1) {
          pag = `<button class="page-btn" ${blockedPage <= 1 ? 'disabled' : ''} onclick="blockedPage=${blockedPage-1};loadBlocked()"><i class="ri-arrow-left-line"></i></button>`;
          for (let i = 1; i <= data.pages; i++) {
            if (i === 1 || i === data.pages || (i >= blockedPage - 2 && i <= blockedPage + 2)) {
              pag += `<button class="page-btn ${i === blockedPage ? 'active' : ''}" onclick="blockedPage=${i};loadBlocked()">${i}</button>`;
            } else if (i === blockedPage - 3 || i === blockedPage + 3) pag += '<span style="color:var(--text-secondary)">...</span>';
          }
          pag += `<button class="page-btn" ${blockedPage >= data.pages ? 'disabled' : ''} onclick="blockedPage=${blockedPage+1};loadBlocked()"><i class="ri-arrow-right-line"></i></button>`;
        }
        document.getElementById('blockedPagination').innerHTML = pag;
      } catch (e) { console.error(e); tbody.innerHTML = '<tr><td colspan="7" style="color:var(--danger)">Erro ao carregar</td></tr>'; }
    }

    async function viewVisitor(id) {
      document.getElementById('visitorModal').classList.add('active');
      document.getElementById('visitorDetails').innerHTML = '<div class="loading"><div class="spinner"></div></div>';
      try {
        const res = await fetch(`/api/visitors/${id}`);
        const v = await res.json();
        document.getElementById('visitorDetails').innerHTML = `
          <div class="info-grid">
            <div><h4 style="margin-bottom:15px;color:var(--accent)">üìç Localiza√ß√£o</h4>
              <div class="info-item"><span class="info-label">IP</span><span class="info-value">${v.ip||'-'}</span></div>
              <div class="info-item"><span class="info-label">Pa√≠s</span><span class="info-value">${v.country||'-'}</span></div>
              <div class="info-item"><span class="info-label">Regi√£o</span><span class="info-value">${v.region||'-'}</span></div>
              <div class="info-item"><span class="info-label">Cidade</span><span class="info-value">${v.city||'-'}</span></div>
              <div class="info-item"><span class="info-label">ISP</span><span class="info-value">${v.isp||'-'}</span></div>
            </div>
            <div><h4 style="margin-bottom:15px;color:var(--accent)">üì± Dispositivo</h4>
              <div class="info-item"><span class="info-label">Tipo</span><span class="info-value">${v.device_type||'desktop'}</span></div>
              <div class="info-item"><span class="info-label">Navegador</span><span class="info-value">${v.browser||'-'} ${v.browser_version||''}</span></div>
              <div class="info-item"><span class="info-label">Sistema</span><span class="info-value">${v.os||'-'}</span></div>
              <div class="info-item"><span class="info-label">Tela</span><span class="info-value">${(v.screen_width && v.screen_height) ? (v.screen_width + 'x' + v.screen_height) : '-'}</span></div>
            </div>
            <div><h4 style="margin-bottom:15px;color:var(--accent)">üîç Detec√ß√£o</h4>
              <div class="info-item"><span class="info-label">Status</span><span class="info-value">${v.was_blocked?'üö´ Bloqueado':'‚úÖ Permitido'}</span></div>
              <div class="info-item"><span class="info-label">Motivo</span><span class="info-value">${v.block_reason||'-'}</span></div>
              <div class="info-item"><span class="info-label">Bot?</span><span class="info-value">${v.is_bot?'‚ö†Ô∏è Sim':'N√£o'}</span></div>
              <div class="info-item"><span class="info-label">Site</span><span class="info-value">${v.site_id||'default'}</span></div>
            </div>
            <div><h4 style="margin-bottom:15px;color:var(--accent)">üîó Rastreamento</h4>
              <div class="info-item"><span class="info-label">Referrer</span><span class="info-value">${v.referrer||'-'}</span></div>
              <div class="info-item"><span class="info-label">UTM Source</span><span class="info-value">${v.utm_source||'-'}</span></div>
              <div class="info-item"><span class="info-label">UTM Campaign</span><span class="info-value">${v.utm_campaign||'-'}</span></div>
              <div class="info-item"><span class="info-label">Data (Bras√≠lia)</span><span class="info-value">${formatDateTimeBR(v.created_at)}</span></div>
            </div>
          </div>
          <div style="margin-top:20px"><h4 style="margin-bottom:10px;color:var(--accent)">User-Agent</h4><div class="code-block" style="font-size:11px;word-break:break-all">${v.user_agent||'-'}</div></div>
        `;
      } catch (e) { document.getElementById('visitorDetails').innerHTML = '<p style="color:var(--danger)">Erro ao carregar</p>'; }
    }

    function closeVisitorModal() { document.getElementById('visitorModal').classList.remove('active'); }

    // Script section
    function loadScriptSection() { updateSiteSelectors(); }

    async function generateLinkFromUrl() {
      const url = (document.getElementById('quickTargetUrl').value || '').trim();
      if (!url) { alert('Cole a URL da sua landing page no campo acima.'); return; }
      const name = (document.getElementById('quickSiteName').value || '').trim() || ('Landing ' + new Date().toLocaleDateString('pt-BR'));
      try {
        const res = await fetch('/api/sites', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name,
            target_url: url,
            redirect_url: 'https://www.google.com/',
            allowed_countries: 'BR'
          })
        });
        if (!res.ok) throw new Error('Erro ao criar');
        const site = await res.json();
        const link = window.location.origin + '/go/' + site.link_code;
        await loadSites();
        document.getElementById('generatedLinkText').textContent = link;
        document.getElementById('generatedLinkBox').style.display = 'block';
        document.getElementById('scriptSiteSelector').value = site.site_id;
        updateScriptCode();
      } catch (e) {
        alert('Erro ao gerar link. Tente novamente.');
      }
    }
    
    function updateScriptCode() {
      const siteId = document.getElementById('scriptSiteSelector').value;
      const block = document.getElementById('scriptCodeBlock');
      const code = document.getElementById('scriptCode');
      if (!siteId) { block.style.display = 'none'; return; }
      block.style.display = 'block';
      const site = sites.find(s => s.site_id === siteId);
      if (site && site.link_code) {
        code.textContent = window.location.origin + '/go/' + site.link_code;
      } else {
        code.textContent = 'Salve a URL do seu site e edite o site para gerar o link.';
      }
    }

    function copyScript() {
      const code = document.getElementById('scriptCode').textContent;
      copyToClipboard(code);
    }

    function copyToClipboard(text) {
      navigator.clipboard.writeText(text);
      alert('Copiado!');
    }

    function exportData(format) { window.open(`/api/export?format=${format}`, '_blank'); }

    // Init
    loadSites();
    refreshStats();
    setInterval(() => { if (document.getElementById('dashboard').classList.contains('active')) refreshStats(); }, 30000);

    document.getElementById('visitorModal').addEventListener('click', e => { if (e.target.id === 'visitorModal') closeVisitorModal(); });
    document.getElementById('siteModal').addEventListener('click', e => { if (e.target.id === 'siteModal') closeSiteModal(); });
  </script>
</body>
</html>
