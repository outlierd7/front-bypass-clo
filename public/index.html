<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üëª GhostVic - Painel Stealth</title>
  <link rel="icon"
    href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üëª</text></svg>"
    type="image/svg+xml">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg-primary: #0d1117;
      --bg-secondary: #161b22;
      --bg-card: #1c2128;
      --bg-hover: #21262d;
      --accent-primary: #58a6ff;
      --accent-secondary: #7c3aed;
      --accent-solid: #58a6ff;
      --accent-gradient: linear-gradient(135deg, #58a6ff 0%, #7c3aed 100%);
      --success: #3fb950;
      --warning: #d29922;
      --danger: #f85149;
      --info: #58a6ff;
      --text-primary: #f0f6fc;
      --text-secondary: #8b949e;
      --text-tertiary: #6e7681;
      --border: rgba(48, 54, 61, 0.8);
      --border-hover: rgba(88, 166, 255, 0.4);
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.4);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.5);
      --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.6);
      --shadow-xl: 0 12px 32px rgba(0, 0, 0, 0.7);
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg-primary);
      background-image:
        linear-gradient(135deg, rgba(88, 166, 255, 0.03) 0%, transparent 50%),
        linear-gradient(225deg, rgba(124, 58, 237, 0.03) 0%, transparent 50%);
      color: var(--text-primary);
      min-height: 100vh;
      line-height: 1.6;
      position: relative;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background:
        radial-gradient(circle at 20% 30%, rgba(88, 166, 255, 0.05) 0%, transparent 50%),
        radial-gradient(circle at 80% 70%, rgba(124, 58, 237, 0.05) 0%, transparent 50%);
      pointer-events: none;
      z-index: 0;
    }

    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      width: 280px;
      height: 100vh;
      background: var(--bg-secondary);
      border-right: 1px solid var(--border);
      padding: 24px;
      z-index: 100;
      display: flex;
      flex-direction: column;
      box-shadow: 4px 0 24px rgba(0, 0, 0, 0.6);
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 12px 0 32px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 24px;
      position: relative;
    }

    .logo::after {
      content: '';
      position: absolute;
      bottom: -1px;
      left: 0;
      width: 60px;
      height: 2px;
      background: var(--accent-solid);
    }

    .logo i {
      font-size: 32px;
      color: var(--accent-solid);
    }

    .logo h1 {
      font-size: 22px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .nav-menu {
      list-style: none;
      flex: 1;
      overflow-y: auto;
    }

    .nav-item {
      margin-bottom: 8px;
    }

    .nav-link {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 14px 16px;
      border-radius: 8px;
      color: var(--text-secondary);
      text-decoration: none;
      transition: all 0.2s ease;
      cursor: pointer;
      position: relative;
      border-left: 3px solid transparent;
    }

    .nav-link:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
      border-left-color: var(--accent-solid);
    }

    .nav-link.active {
      background: rgba(88, 166, 255, 0.1);
      color: var(--accent-solid);
      border-left-color: var(--accent-solid);
      font-weight: 600;
    }

    .nav-link i {
      font-size: 20px;
    }

    .main {
      margin-left: 280px;
      padding: 32px;
      min-height: 100vh;
      position: relative;
      z-index: 1;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 32px;
      flex-wrap: wrap;
      gap: 20px;
    }

    .header h2 {
      font-size: 32px;
      font-weight: 700;
      color: var(--text-primary);
      letter-spacing: -0.5px;
    }

    .header-actions {
      display: flex;
      gap: 16px;
      align-items: center;
      flex-wrap: wrap;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 12px 24px;
      border-radius: 12px;
      border: none;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }

    .btn:hover::before {
      width: 300px;
      height: 300px;
    }

    .btn-primary {
      background: var(--accent-solid);
      color: white;
      box-shadow: 0 4px 12px rgba(88, 166, 255, 0.3);
      border: 1px solid var(--accent-solid);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(88, 166, 255, 0.4);
      background: #6ab0ff;
    }

    .btn-secondary {
      background: var(--bg-card);
      color: var(--text-primary);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      background: var(--bg-hover);
      border-color: var(--border-hover);
    }

    .btn-danger {
      background: var(--danger);
      color: white;
      box-shadow: var(--shadow-md);
      border: 1px solid var(--danger);
    }

    .btn-danger:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(239, 68, 68, 0.6);
    }

    .btn-sm {
      padding: 8px 16px;
      font-size: 12px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 24px;
      margin-bottom: 32px;
    }

    .stat-card {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 24px;
      border: 1px solid var(--border);
      position: relative;
      transition: all 0.2s ease;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--accent-solid);
      border-radius: 12px 12px 0 0;
    }

    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
      border-color: var(--border-hover);
    }

    .stat-card.success::before {
      background: var(--success);
    }

    .stat-card.warning::before {
      background: var(--warning);
    }

    .stat-card.danger::before {
      background: var(--danger);
    }

    .stat-icon {
      width: 56px;
      height: 56px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      margin-bottom: 16px;
      background: rgba(88, 166, 255, 0.1);
      color: var(--accent-solid);
    }

    .stat-card.success .stat-icon {
      background: rgba(63, 185, 80, 0.1);
      color: var(--success);
    }

    .stat-card.warning .stat-icon {
      background: rgba(210, 153, 34, 0.1);
      color: var(--warning);
    }

    .stat-card.danger .stat-icon {
      background: rgba(248, 81, 73, 0.1);
      color: var(--danger);
    }

    .stat-value {
      font-size: 36px;
      font-weight: 800;
      margin-bottom: 8px;
      color: var(--text-primary);
    }

    .stat-label {
      color: var(--text-secondary);
      font-size: 13px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .card {
      background: var(--bg-card);
      border-radius: 12px;
      border: 1px solid var(--border);
      margin-bottom: 24px;
      overflow: hidden;
      box-shadow: var(--shadow-md);
      transition: all 0.2s ease;
    }

    .card:hover {
      border-color: var(--border-hover);
      box-shadow: var(--shadow-lg);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
      background: rgba(88, 166, 255, 0.03);
    }

    .card-title {
      font-size: 18px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 12px;
      color: var(--text-primary);
    }

    .card-body {
      padding: 24px;
    }

    .table-container {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th,
    td {
      padding: 16px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }

    th {
      color: var(--text-secondary);
      font-weight: 700;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      background: rgba(88, 166, 255, 0.05);
      border-bottom: 2px solid var(--border);
    }

    tr:hover {
      background: rgba(88, 166, 255, 0.02);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .badge-success {
      background: rgba(63, 185, 80, 0.15);
      color: var(--success);
    }

    .badge-danger {
      background: rgba(248, 81, 73, 0.15);
      color: var(--danger);
    }

    .badge-warning {
      background: rgba(210, 153, 34, 0.15);
      color: var(--warning);
    }

    .badge-info {
      background: rgba(88, 166, 255, 0.15);
      color: var(--info);
    }

    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .chart-container {
      height: 280px;
      position: relative;
    }

    .filters {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .filter-btn {
      padding: 8px 14px;
      border-radius: 8px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.3s;
      font-size: 12px;
    }

    .filter-btn:hover,
    .filter-btn.active {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(8px);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: var(--bg-card);
      border-radius: 12px;
      width: 90%;
      max-width: 900px;
      max-height: 90vh;
      overflow-y: auto;
      border: 1px solid var(--border);
      box-shadow: var(--shadow-xl);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 24px;
      border-bottom: 1px solid var(--border);
      background: rgba(88, 166, 255, 0.03);
    }

    .modal-header h3 {
      font-size: 22px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .modal-body {
      padding: 24px;
    }

    .modal-close {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 28px;
      cursor: pointer;
      transition: all 0.3s;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
    }

    .modal-close:hover {
      background: var(--bg-hover);
      color: var(--danger);
      transform: rotate(90deg);
    }

    .form-group {
      margin-bottom: 24px;
    }

    .form-label {
      display: block;
      margin-bottom: 10px;
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .radio-label {
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--text-primary);
      font-size: 14px;
      cursor: pointer;
    }

    .radio-label input[type="radio"] {
      margin: 0;
    }

    .form-input,
    .form-select {
      width: 100%;
      padding: 14px 18px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-size: 14px;
      transition: all 0.3s;
    }

    .form-input:focus,
    .form-select:focus {
      outline: none;
      border-color: var(--accent-solid);
      box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.1);
      background: var(--bg-primary);
    }

    .switch {
      position: relative;
      display: inline-block;
      width: 56px;
      height: 30px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--bg-secondary);
      transition: 0.4s;
      border-radius: 30px;
      border: 2px solid var(--border);
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 22px;
      width: 22px;
      left: 2px;
      bottom: 2px;
      background: var(--text-secondary);
      transition: 0.4s;
      border-radius: 50%;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
    }

    input:checked+.slider {
      background: var(--accent-solid);
      border-color: var(--accent-solid);
    }

    input:checked+.slider:before {
      transform: translateX(26px);
      background: white;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 24px;
    }

    .info-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 0;
      border-bottom: 1px solid var(--border);
    }

    .info-label {
      color: var(--text-secondary);
      font-size: 13px;
      font-weight: 500;
    }

    .info-value {
      font-weight: 600;
      text-align: right;
      word-break: break-all;
      max-width: 60%;
      color: var(--text-primary);
    }

    .code-block {
      background: var(--bg-primary);
      border-radius: 12px;
      padding: 24px;
      font-family: 'Fira Code', 'Consolas', 'Monaco', monospace;
      font-size: 13px;
      overflow-x: auto;
      border: 1px solid var(--border);
      position: relative;
      box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.4);
    }

    .copy-btn {
      position: absolute;
      top: 12px;
      right: 12px;
      padding: 10px 18px;
      background: var(--accent-solid);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      transition: all 0.2s ease;
      box-shadow: var(--shadow-sm);
    }

    .copy-btn:hover {
      transform: translateY(-2px);
      background: #6ab0ff;
      box-shadow: var(--shadow-md);
    }

    .pagination {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-top: 20px;
    }

    .page-btn {
      padding: 8px 14px;
      border-radius: 8px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      color: var(--text-primary);
      cursor: pointer;
      font-size: 13px;
    }

    .page-btn:hover,
    .page-btn.active {
      background: var(--accent);
      border-color: var(--accent);
    }

    .page-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .country-checkbox-container {
      max-height: 400px;
      overflow-y: auto;
      padding: 16px;
      background: var(--bg-secondary);
      border-radius: 12px;
      border: 1px solid var(--border);
    }

    .country-checkbox-container::-webkit-scrollbar {
      width: 8px;
    }

    .country-checkbox-container::-webkit-scrollbar-track {
      background: var(--bg-primary);
      border-radius: 4px;
    }

    .country-checkbox-container::-webkit-scrollbar-thumb {
      background: var(--accent-solid);
      border-radius: 4px;
    }

    .country-checkbox-item {
      display: flex;
      align-items: center;
      padding: 10px 12px;
      margin-bottom: 4px;
      border-radius: 8px;
      transition: all 0.2s;
      cursor: pointer;
    }

    .country-checkbox-item:hover {
      background: var(--bg-hover);
    }

    .country-checkbox-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
      margin-right: 12px;
      cursor: pointer;
      accent-color: var(--accent-solid);
    }

    .country-checkbox-item label {
      flex: 1;
      cursor: pointer;
      color: var(--text-secondary);
      font-size: 13px;
      transition: color 0.2s;
    }

    .country-checkbox-item:hover label {
      color: var(--text-primary);
    }

    .country-actions {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }

    .country-action-btn {
      padding: 8px 14px;
      border-radius: 8px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      color: var(--text-secondary);
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      font-weight: 600;
    }

    .country-action-btn:hover {
      background: var(--bg-hover);
      color: var(--accent-solid);
      border-color: var(--border-hover);
    }

    .last-update {
      font-size: 12px;
      color: var(--text-tertiary);
      margin-top: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .last-update::before {
      content: '‚Ä¢';
      color: var(--success);
      font-size: 16px;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.3;
      }
    }

    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 60px;
    }

    .spinner {
      width: 48px;
      height: 48px;
      border: 4px solid var(--border);
      border-top-color: var(--accent-solid);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .section {
      display: none;
    }

    .section.active {
      display: block;
      animation: fadeIn 0.4s ease-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .period-selector {
      display: flex;
      gap: 6px;
      background: var(--bg-secondary);
      padding: 6px;
      border-radius: 12px;
      border: 1px solid var(--border);
    }

    .period-btn {
      padding: 10px 16px;
      border: none;
      background: none;
      color: var(--text-secondary);
      border-radius: 8px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      transition: all 0.3s;
    }

    .period-btn.active {
      background: var(--accent-solid);
      color: white;
      box-shadow: var(--shadow-sm);
    }

    .period-btn:hover:not(.active) {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    .site-selector {
      min-width: 200px;
    }

    .site-card {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 24px;
      border: 1px solid var(--border);
      margin-bottom: 16px;
      transition: all 0.2s ease;
      box-shadow: var(--shadow-md);
    }

    .site-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
      border-color: var(--border-hover);
    }

    .site-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .site-card-title {
      font-size: 17px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .site-card-domain {
      color: var(--text-tertiary);
      font-size: 13px;
      margin-top: 4px;
    }

    .site-card-stats {
      display: flex;
      gap: 24px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border);
    }

    .site-card-stat {
      text-align: center;
    }

    .site-card-stat-value {
      font-size: 22px;
      font-weight: 800;
      color: var(--accent-solid);
    }

    .site-card-stat-label {
      font-size: 11px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .empty-state {
      text-align: center;
      padding: 80px 20px;
      color: var(--text-secondary);
    }

    .empty-state i {
      font-size: 72px;
      margin-bottom: 24px;
      opacity: 0.2;
      color: var(--accent-solid);
    }

    .empty-state h3 {
      margin-bottom: 12px;
      color: var(--text-primary);
      font-size: 20px;
      font-weight: 600;
    }

    .sidebar-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(4px);
      z-index: 99;
    }

    .sidebar-overlay.active {
      display: block;
    }

    .menu-toggle {
      display: none;
      position: fixed;
      top: 16px;
      left: 16px;
      z-index: 101;
      width: 48px;
      height: 48px;
      border-radius: 12px;
      background: var(--accent-solid);
      color: white;
      border: none;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      cursor: pointer;
      box-shadow: var(--shadow-md);
    }

    .country-select-wrap {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
    }

    .country-select-wrap .form-group {
      margin-bottom: 0;
    }

    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 24px;
      margin-bottom: 24px;
    }

    .chart-container {
      height: 300px;
      position: relative;
    }

    .filters {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .filter-btn {
      padding: 10px 16px;
      border-radius: 10px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.3s;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .filter-btn:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    .filter-btn.active {
      background: var(--accent-solid);
      color: white;
      border-color: var(--accent-solid);
    }

    .pagination {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 24px;
    }

    .page-btn {
      padding: 10px 16px;
      border-radius: 10px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      color: var(--text-primary);
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.3s;
    }

    .page-btn:hover:not(:disabled) {
      background: var(--bg-hover);
      border-color: var(--border-hover);
    }

    .page-btn.active {
      background: var(--accent-solid);
      border-color: var(--accent-solid);
      color: white;
    }

    .page-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    @media (max-width: 768px) {
      .menu-toggle {
        display: flex;
      }

      .sidebar {
        width: 300px;
        transform: translateX(-100%);
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .sidebar.open {
        transform: translateX(0);
      }

      .main {
        margin-left: 0;
        padding: 72px 16px 24px;
      }

      .header {
        flex-direction: column;
        align-items: flex-start;
      }

      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
      }

      .country-select-wrap {
        grid-template-columns: 1fr;
      }

      .stat-value {
        font-size: 28px;
      }

      .charts-grid {
        grid-template-columns: 1fr;
      }

      .chart-container {
        height: 240px;
      }

      .table-container {
        font-size: 12px;
      }

      th,
      td {
        padding: 10px 12px;
      }

      .period-selector {
        flex-wrap: wrap;
      }

      .header-actions {
        width: 100%;
      }

      .site-selector {
        width: 100%;
      }
    }

    @media (max-width: 480px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }

      .stat-value {
        font-size: 24px;
      }
    }

    /* ========== TEMA FUTURISTA MODERNO - CORES S√ìLIDAS ========== */

    /* Cards modernos com bordas s√≥lidas */
    .glass-card {
      background: var(--bg-card) !important;
      border: 1px solid var(--border) !important;
      box-shadow: var(--shadow-md) !important;
    }

    .glass-card:hover {
      border-color: var(--border-hover) !important;
      box-shadow: var(--shadow-lg) !important;
    }

    /* Textos s√≥lidos */
    .neon-text {
      color: var(--text-primary) !important;
      font-weight: 700;
    }

    /* Inputs modernos */
    .futuristic-input {
      background: var(--bg-secondary) !important;
      border: 1px solid var(--border) !important;
      border-radius: 8px !important;
      padding: 12px 16px !important;
      color: var(--text-primary) !important;
      transition: all 0.2s ease !important;
    }

    .futuristic-input:focus {
      outline: none !important;
      border-color: var(--accent-solid) !important;
      box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.1) !important;
      background: var(--bg-primary) !important;
    }

    .futuristic-input::placeholder {
      color: var(--text-tertiary);
    }

    /* Bot√µes s√≥lidos */
    .neon-btn {
      background: var(--accent-solid) !important;
      border: 1px solid var(--accent-solid) !important;
      box-shadow: var(--shadow-md) !important;
    }

    .neon-btn:hover {
      background: #6ab0ff !important;
      transform: translateY(-2px) !important;
      box-shadow: var(--shadow-lg) !important;
    }

    /* Scrollbar moderna */
    ::-webkit-scrollbar {
      width: 10px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-secondary);
      border-radius: 5px;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--accent-solid);
      border-radius: 5px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #6ab0ff;
    }

    /* Melhorias gerais */
    th {
      background: rgba(88, 166, 255, 0.05) !important;
    }

    tr:hover {
      background: rgba(88, 166, 255, 0.02) !important;
    }

    .badge-success {
      background: rgba(63, 185, 80, 0.15) !important;
      color: var(--success) !important;
      box-shadow: none !important;
    }

    .badge-danger {
      background: rgba(248, 81, 73, 0.15) !important;
      color: var(--danger) !important;
      box-shadow: none !important;
    }

    .badge-warning {
      background: rgba(210, 153, 34, 0.15) !important;
      color: var(--warning) !important;
      box-shadow: none !important;
    }

    .badge-info {
      background: rgba(88, 166, 255, 0.15) !important;
      color: var(--info) !important;
      box-shadow: none !important;
    }

    .copy-btn {
      background: var(--accent-solid) !important;
      box-shadow: var(--shadow-sm) !important;
    }

    .copy-btn:hover {
      background: #6ab0ff !important;
      box-shadow: var(--shadow-md) !important;
    }

    .period-btn.active {
      background: var(--accent-solid) !important;
      box-shadow: var(--shadow-sm) !important;
    }

    .site-card {
      background: var(--bg-card) !important;
    }

    .empty-state i {
      color: var(--accent-solid) !important;
      opacity: 0.3 !important;
    }
  </style>
</head>

<body>
  <button class="menu-toggle" id="menuToggle" type="button" aria-label="Abrir menu"><i
      class="ri-menu-line"></i></button>
  <div class="sidebar-overlay" id="sidebarOverlay"></div>
  <aside class="sidebar" id="sidebar">
    <div class="logo">
      <i class="ri-ghost-smile-line"></i>
      <h1>GhostVic</h1>
    </div>
    <ul class="nav-menu">
      <li class="nav-item"><a class="nav-link active" data-section="dashboard"><i class="ri-dashboard-3-line"></i>
          Dashboard</a></li>
      <li class="nav-item"><a class="nav-link" data-section="sites"><i class="ri-global-line"></i> Meus Sites</a></li>
      <li class="nav-item"><a class="nav-link" data-section="visitors"><i class="ri-user-line"></i> Visitantes</a></li>
      <li class="nav-item"><a class="nav-link" data-section="reports"><i class="ri-file-list-3-line"></i> Permitidos e
          Bloqueados</a></li>
      <li class="nav-item"><a class="nav-link" data-section="script"><i class="ri-link"></i> Link para Ads</a></li>
      <li class="nav-item"><a class="nav-link" data-section="settings"><i class="ri-settings-3-line"></i>
          Configura√ß√µes</a></li>
      <li class="nav-item" id="navUsers" style="display:none"><a class="nav-link" data-section="users"><i
            class="ri-team-line"></i> Usu√°rios</a></li>
      <li class="nav-item"><a class="nav-link" data-section="domains"><i class="ri-global-line"></i> Dom√≠nios</a></li>
      <li class="nav-item"><a class="nav-link" data-section="pages"><i class="ri-file-code-line"></i> P√°ginas</a></li>
    </ul>
    <div style="margin-top: auto; padding-top: 20px; border-top: 1px solid var(--border);">
      <button type="button" class="nav-link"
        style="width:100%; background:none; border:none; color: var(--text-secondary); cursor: pointer;"
        onclick="logout()"><i class="ri-logout-box-line"></i> Sair</button>
    </div>
  </aside>
  <script>
    (function () {
      var sidebar = document.getElementById('sidebar');
      var overlay = document.getElementById('sidebarOverlay');
      var toggle = document.getElementById('menuToggle');
      function openMenu() { sidebar.classList.add('open'); overlay.classList.add('active'); toggle.setAttribute('aria-label', 'Fechar menu'); toggle.innerHTML = '<i class="ri-close-line"></i>'; }
      function closeMenu() { sidebar.classList.remove('open'); overlay.classList.remove('active'); toggle.setAttribute('aria-label', 'Abrir menu'); toggle.innerHTML = '<i class="ri-menu-line"></i>'; }
      toggle.addEventListener('click', function () { sidebar.classList.contains('open') ? closeMenu() : openMenu(); });
      overlay.addEventListener('click', closeMenu);
      document.querySelectorAll('.nav-link').forEach(function (link) { link.addEventListener('click', function () { if (window.innerWidth <= 768) closeMenu(); }); });
    })();
  </script>

  <main class="main">
    <!-- Dashboard -->
    <section id="dashboard" class="section active">
      <div class="header">
        <div>
          <h2>Dashboard</h2>
          <p style="color: var(--text-secondary); font-size: 13px; margin-top: 4px;">Hor√°rio de Bras√≠lia (BRT) ¬∑
            Atualiza√ß√£o autom√°tica a cada 30s</p>
          <p class="last-update" id="dashboardLastUpdate">√öltima atualiza√ß√£o: ‚Äî</p>
        </div>
        <div class="header-actions">
          <select class="form-select site-selector" id="dashboardSiteFilter" onchange="refreshStats()">
            <option value="all">Todos os Sites</option>
          </select>
          <div class="period-selector">
            <button class="period-btn active" data-period="today">Hoje</button>
            <button class="period-btn" data-period="yesterday">Ontem</button>
            <button class="period-btn" data-period="7d">7 dias</button>
            <button class="period-btn" data-period="15d">15 dias</button>
            <button class="period-btn" data-period="30d">30 dias</button>
          </div>
          <button class="btn btn-primary" onclick="refreshStats(); loadLastVisits();"><i class="ri-refresh-line"></i>
            Atualizar</button>
        </div>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon"><i class="ri-eye-line"></i></div>
          <div class="stat-value" id="statTotal">-</div>
          <div class="stat-label">Total de Visitas</div>
        </div>
        <div class="stat-card success">
          <div class="stat-icon"><i class="ri-check-line"></i></div>
          <div class="stat-value" id="statAllowed">-</div>
          <div class="stat-label">Permitidos</div>
        </div>
        <div class="stat-card danger">
          <div class="stat-icon"><i class="ri-forbid-line"></i></div>
          <div class="stat-value" id="statBlocked">-</div>
          <div class="stat-label">Bloqueados</div>
        </div>
        <div class="stat-card warning">
          <div class="stat-icon"><i class="ri-robot-line"></i></div>
          <div class="stat-value" id="statBots">-</div>
          <div class="stat-label">Bots</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon"><i class="ri-smartphone-line"></i></div>
          <div class="stat-value" id="statMobile">-</div>
          <div class="stat-label">Mobile</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon"><i class="ri-computer-line"></i></div>
          <div class="stat-value" id="statDesktop">-</div>
          <div class="stat-label">Desktop</div>
        </div>
      </div>

      <div class="charts-grid">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title"><i class="ri-line-chart-line"></i> Visitas por Hora</h3>
          </div>
          <div class="card-body">
            <div class="chart-container"><canvas id="chartHourly"></canvas></div>
          </div>
        </div>
        <div class="card">
          <div class="card-header">
            <h3 class="card-title"><i class="ri-pie-chart-line"></i> Por Navegador</h3>
          </div>
          <div class="card-body">
            <div class="chart-container"><canvas id="chartBrowser"></canvas></div>
          </div>
        </div>
      </div>
      <div class="charts-grid">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title"><i class="ri-global-line"></i> Por Pa√≠s</h3>
          </div>
          <div class="card-body">
            <div class="chart-container"><canvas id="chartCountry"></canvas></div>
          </div>
        </div>
        <div class="card">
          <div class="card-header">
            <h3 class="card-title"><i class="ri-prohibited-line"></i> Motivos de Bloqueio</h3>
          </div>
          <div class="card-body">
            <div class="chart-container"><canvas id="chartBlockReasons"></canvas></div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h3 class="card-title"><i class="ri-time-line"></i> √öltimos acessos (hor√°rio Bras√≠lia)</h3>
          <a href="#" class="btn btn-secondary btn-sm"
            onclick="document.querySelector('[data-section=visitors]').click(); return false;">Ver todos</a>
        </div>
        <div class="card-body">
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Data/Hora (BRT)</th>
                  <th>IP</th>
                  <th>Site</th>
                  <th>Status</th>
                  <th>Pa√≠s</th>
                  <th>Dispositivo</th>
                  <th>Motivo</th>
                  <th>A√ß√µes</th>
                </tr>
              </thead>
              <tbody id="lastVisitsTable">
                <tr>
                  <td colspan="8" class="loading">
                    <div class="spinner"></div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- Sites -->
    <section id="sites" class="section">
      <div class="header">
        <h2>Meus Sites</h2>
        <button class="btn btn-primary" onclick="openNewSiteModal()"><i class="ri-add-line"></i> Novo Site</button>
      </div>
      <div id="sitesList"></div>
    </section>

    <!-- Visitors -->
    <section id="visitors" class="section">
      <div class="header">
        <h2>Visitantes</h2>
        <div class="header-actions">
          <select class="form-select site-selector" id="visitorsSiteFilter" onchange="loadVisitors()">
            <option value="all">Todos os Sites</option>
          </select>
          <div class="filters">
            <button class="filter-btn active" data-filter="all">Todos</button>
            <button class="filter-btn" data-filter="allowed">Permitidos</button>
            <button class="filter-btn" data-filter="blocked">Bloqueados</button>
            <button class="filter-btn" data-filter="bots">Bots</button>
            <button class="filter-btn" data-filter="mobile">Mobile</button>
          </div>
          <button class="btn btn-secondary" onclick="exportData('csv')"><i class="ri-download-line"></i>
            Exportar</button>
        </div>
      </div>
      <div class="card">
        <div class="card-body">
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Data</th>
                  <th>IP</th>
                  <th>Site</th>
                  <th>Status</th>
                  <th>Pa√≠s</th>
                  <th>Dispositivo</th>
                  <th>UTM Source</th>
                  <th>UTM Medium</th>
                  <th>UTM Campaign</th>
                  <th>Navegador</th>
                  <th>A√ß√µes</th>
                </tr>
              </thead>
              <tbody id="visitorsTable">
                <tr>
                  <td colspan="11" class="loading">
                    <div class="spinner"></div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="pagination" id="pagination"></div>
        </div>
      </div>
    </section>

    <!-- Permitidos e Bloqueados -->
    <section id="reports" class="section">
      <div class="header">
        <h2>Permitidos e Bloqueados</h2>
        <div class="header-actions">
          <select class="form-select site-selector" id="reportsSiteFilter" onchange="loadReports()">
            <option value="all">Todos os Sites</option>
          </select>
          <button class="btn btn-primary" onclick="loadReports()"><i class="ri-refresh-line"></i> Atualizar</button>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h3 class="card-title"><i class="ri-check-line" style="color:var(--success)"></i> Visitantes Permitidos (com
            UTMs e origem)</h3>
        </div>
        <div class="card-body">
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Data</th>
                  <th>Site</th>
                  <th>Pa√≠s</th>
                  <th>Dispositivo</th>
                  <th>UTM Source</th>
                  <th>UTM Medium</th>
                  <th>UTM Campaign</th>
                  <th>Referrer</th>
                  <th>A√ß√µes</th>
                </tr>
              </thead>
              <tbody id="permittedTable">
                <tr>
                  <td colspan="9" class="loading">
                    <div class="spinner"></div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="pagination" id="permittedPagination"></div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h3 class="card-title"><i class="ri-forbid-line" style="color:var(--danger)"></i> Visitantes Bloqueados</h3>
        </div>
        <div class="card-body">
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Data</th>
                  <th>Site</th>
                  <th>Pa√≠s</th>
                  <th>Motivo do bloqueio</th>
                  <th>Dispositivo</th>
                  <th>Navegador</th>
                  <th>A√ß√µes</th>
                </tr>
              </thead>
              <tbody id="blockedTable">
                <tr>
                  <td colspan="7" class="loading">
                    <div class="spinner"></div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="pagination" id="blockedPagination"></div>
        </div>
      </div>
    </section>

    <!-- Script/Integra√ß√£o -->
    <section id="script" class="section">
      <div class="header">
        <h2>Link para Ads</h2>
      </div>
      <!-- Gerar link direto: colar URL ‚Üí gerar link para usar nos Ads -->
      <div class="card" style="border: 2px solid var(--accent);">
        <div class="card-header">
          <h3 class="card-title"><i class="ri-links-line"></i> Gerar novo link para Ads</h3>
        </div>
        <div class="card-body">
          <p style="color: var(--text-secondary); margin-bottom: 15px;">Cole o link da sua landing page abaixo e clique
            em <strong>Gerar link</strong>. Use o link gerado como <strong>URL de destino</strong> nos seus an√∫ncios
            (Meta Ads, Google Ads, etc.).</p>
          <div class="form-group">
            <label class="form-label">URL da sua landing page</label>
            <input type="url" class="form-input" id="quickTargetUrl" placeholder="https://seusite.com/landing">
          </div>
          <div class="form-group">
            <label class="form-label">Nome (opcional ‚Äì para identificar no painel)</label>
            <input type="text" class="form-input" id="quickSiteName" placeholder="Ex: Campanha Janeiro">
          </div>
          <div class="form-group">
            <label class="form-label">Usar dom√≠nio:</label>
            <select class="form-select" id="quickDomainSelect" style="max-width: 300px;">
              <option value="">Padr√£o</option>
            </select>
          </div>
          <button class="btn btn-primary" onclick="generateLinkFromUrl()"><i class="ri-link"></i> Gerar link para
            Ads</button>
          <div id="generatedLinkBox"
            style="display: none; margin-top: 20px; padding: 20px; background: var(--bg-secondary); border-radius: 10px; border: 1px solid var(--success);">
            <div class="form-label" style="margin-bottom: 8px;">‚úÖ Link gerado ‚Äì use esse link nos seus an√∫ncios:</div>
            <div class="code-block" style="margin-bottom: 10px;">
              <button class="copy-btn" id="copyGeneratedLinkBtn"
                onclick="copyToClipboard(document.getElementById('generatedLinkText').textContent)"><i
                  class="ri-file-copy-line"></i> Copiar</button>
              <pre id="generatedLinkText"></pre>
            </div>
            <p style="color: var(--text-secondary); font-size: 12px;">N√£o precisa colocar nenhum script no seu site. S√≥
              use esse link como URL de destino nos Ads.</p>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="card-header">
          <h3 class="card-title"><i class="ri-information-line"></i> Como funciona</h3>
        </div>
        <div class="card-body">
          <p style="margin-bottom: 20px; line-height: 1.8;">
            <strong>1.</strong> Em "Meus Sites", cadastre seu site e coloque a <strong>URL da sua landing page</strong>
            (o link real do seu site).<br>
            <strong>2.</strong> O sistema gera um <strong>novo link</strong> para voc√™ (ex:
            <code>https://seu-painel.up.railway.app/go/abc12xyz</code>).<br>
            <strong>3.</strong> Use esse novo link como <strong>URL de destino</strong> nos seus an√∫ncios (Meta Ads,
            Google Ads, etc.).<br>
            <strong>4.</strong> Quem clicar no an√∫ncio passa primeiro pelo nosso servidor: se for permitido (ex: mobile,
            Brasil), vai para seu site; se for bloqueado (desktop, bot, etc.), vai para a URL de redirecionamento (ex:
            Google).
          </p>
          <div style="background: var(--bg-secondary); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
            <h4 style="margin-bottom: 10px;">üìå Importante</h4>
            <ul style="color: var(--text-secondary); line-height: 1.8; padding-left: 20px;">
              <li><strong>N√£o precisa colocar nenhum script no seu site.</strong> S√≥ usar o link gerado nos Ads.</li>
              <li>Cada site tem seu pr√≥prio link e configura√ß√µes (pa√≠s, bloqueio de desktop, etc.).</li>
              <li><strong>Par√¢metro de rastreamento:</strong> use o par√¢metro <code>ref=...</code> no Meta Ads
                (Rastreamento ‚Üí Par√¢metros de URL) para que s√≥ quem clicar no an√∫ncio seja permitido; quem acessar o
                link sem esse par√¢metro ser√° bloqueado.</li>
              <li>Os par√¢metros do an√∫ncio (UTM, fbclid, etc.) s√£o repassados para sua landing page.</li>
              <li>Todos os acessos (permitidos e bloqueados) aparecem no painel.</li>
            </ul>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="card-header">
          <h3 class="card-title"><i class="ri-link"></i> Seu link para usar nos Ads</h3>
        </div>
        <div class="card-body">
          <p style="margin-bottom: 15px; color: var(--text-secondary);">Selecione um site e o dom√≠nio para ver e copiar
            o link completo (com ref e par√¢metros padr√£o):</p>
          <select class="form-select" id="scriptSiteSelector" style="max-width: 300px; margin-bottom: 10px;"
            onchange="updateScriptCode()">
            <option value="">Selecione um site...</option>
          </select>
          <div style="margin-bottom: 15px;">
            <label class="form-label" style="font-size: 12px;">Dom√≠nio:</label>
            <select class="form-select" id="scriptDomainSelect" style="max-width: 300px;" onchange="updateScriptCode()">
              <option value="">Padr√£o</option>
            </select>
          </div>
          <div class="code-block" id="scriptCodeBlock" style="display: none;">
            <button class="copy-btn" onclick="copyScript()"><i class="ri-file-copy-line"></i> Copiar link
              completo</button>
            <pre id="scriptCode"></pre>
            <div id="scriptRefParamBox"
              style="display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border);">
              <div class="form-label" style="margin-bottom: 8px;">No Meta Ads, em <strong>Rastreamento ‚Üí Par√¢metros de
                  URL</strong>, adicione (para s√≥ permitir cliques do an√∫ncio):</div>
              <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                <code id="scriptRefParamValue"
                  style="padding: 8px 12px; background: var(--bg-primary); border-radius: 8px; font-size: 13px; word-break: break-all;"></code>
                <button type="button" class="btn btn-sm btn-secondary" onclick="copyRefParam()"><i
                    class="ri-file-copy-line"></i> Copiar par√¢metro</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Configura√ß√µes (dom√≠nio do cloaker ‚Äì por usu√°rio) -->
    <section id="settings" class="section">
      <div class="header">
        <h2>Configura√ß√µes da Conta</h2>
      </div>
      <div class="card glass-card">
        <div class="card-header">
          <h3 class="card-title"><i class="ri-user-line"></i> Alterar Usu√°rio</h3>
        </div>
        <div class="card-body">
          <p style="color: var(--text-secondary); margin-bottom: 20px;">Altere seu nome de usu√°rio para fazer login no
            painel.</p>
          <div class="form-group">
            <label class="form-label">Novo nome de usu√°rio</label>
            <input type="text" class="form-input" id="newUsername" placeholder="Digite o novo usu√°rio">
            <small style="color: var(--text-secondary); font-size: 12px;">M√≠nimo de 2 caracteres.</small>
          </div>
          <button class="btn btn-primary" onclick="updateUsername()"><i class="ri-save-line"></i> Salvar</button>
          <span id="usernameMsg" style="margin-left: 15px; font-size: 13px;"></span>
        </div>
      </div>
      <div class="card glass-card">
        <div class="card-header">
          <h3 class="card-title"><i class="ri-lock-password-line"></i> Alterar Senha</h3>
        </div>
        <div class="card-body">
          <p style="color: var(--text-secondary); margin-bottom: 20px;">Altere sua senha de acesso ao painel.</p>
          <div class="form-group">
            <label class="form-label">Senha atual</label>
            <input type="password" class="form-input" id="currentPassword" placeholder="Digite sua senha atual">
          </div>
          <div class="form-group">
            <label class="form-label">Nova senha</label>
            <input type="password" class="form-input" id="newPassword" placeholder="Digite a nova senha">
            <small style="color: var(--text-secondary); font-size: 12px;">M√≠nimo de 6 caracteres.</small>
          </div>
          <div class="form-group">
            <label class="form-label">Confirmar nova senha</label>
            <input type="password" class="form-input" id="confirmPassword" placeholder="Digite a nova senha novamente">
          </div>
          <button class="btn btn-primary" onclick="updatePassword()"><i class="ri-save-line"></i> Salvar</button>
          <span id="passwordMsg" style="margin-left: 15px; font-size: 13px;"></span>
        </div>
      </div>
      <div class="card" id="backupCard" style="display: none;">
        <div class="card-header">
          <h3 class="card-title"><i class="ri-database-2-line"></i> Backup do banco (admin)</h3>
        </div>
        <div class="card-body">
          <li><strong>No Railway (obrigat√≥rio):</strong> Projeto ‚Üí seu servi√ßo ‚Üí <strong>Networking</strong> ‚Üí <strong>+
              Custom Domain</strong> ‚Üí adicione o dom√≠nio (ex: <code>cloaker.seudominio.com</code> ou
            <code>iniiciopropo.sbs</code>). Sem isso, o dom√≠nio n√£o chega ao seu app.
          </li>
          <li><strong>Tenha um dom√≠nio</strong> (ex: meusite.com.br). Voc√™ pode usar um subdom√≠nio (ex:
            cloaker.meusite.com.br ou go.meusite.com.br).</li>
          <li><strong>Acesse o painel do seu provedor de DNS</strong> (onde o dom√≠nio est√° registrado: Registro.br,
            Cloudflare, GoDaddy, HostGator, etc.).</li>
          <li><strong>Crie um registro CNAME:</strong>
            <ul style="margin-top: 8px; margin-bottom: 8px;">
              <li><strong>Nome/Host:</strong> o subdom√≠nio que voc√™ quer usar (ex: <code>cloaker</code> ou
                <code>go</code>). Se for usar o dom√≠nio raiz (meusite.com.br), use <code>@</code> ou consulte a
                documenta√ß√£o do seu DNS ‚Äì alguns exigem A/ALIAS em vez de CNAME.
              </li>
              <li><strong>Valor/Destino:</strong> aponte para o dom√≠nio do seu app no Railway, ex:
                <code>cloaker-pro-novo-production.up.railway.app</code> (veja em Railway ‚Üí Networking).
              </li>
            </ul>
          </li>
          <li><strong>Aguarde a propaga√ß√£o do DNS</strong> (pode levar de alguns minutos a 48 horas). Voc√™ pode testar
            com <code>nslookup cloaker.seudominio.com</code> no terminal.</li>
          <li><strong>Use HTTPS:</strong> se seu provedor oferecer SSL (ex: Cloudflare ‚ÄúFlexible‚Äù ou ‚ÄúFull‚Äù), ative. A
            URL final deve ser <code>https://cloaker.seudominio.com</code>.</li>
          <li><strong>No painel, em Configura√ß√µes</strong>, preencha o campo acima com a URL completa, por exemplo:
            <code>https://cloaker.seudominio.com</code> (sem barra no final). Clique em <strong>Salvar</strong>.
          </li>
          <li>Pronto. Ao gerar links em <strong>Meus Sites</strong> ou <strong>Link para Ads</strong>, os links sair√£o
            como <code>https://cloaker.seudominio.com/go/XXXXX</code>.</li>
          </ol>
          <p style="color: var(--text-secondary); font-size: 13px;">Cadastre em <strong>Dom√≠nios</strong>, use o destino
            CNAME no DNS e escolha o dom√≠nio ao gerar o link em Meus Sites.</p>
        </div>
      </div>
      <div class="card" id="backupCard" style="display: none;">
        <div class="card-header">
          <h3 class="card-title"><i class="ri-database-2-line"></i> Backup do banco (admin)</h3>
        </div>
        <div class="card-body">
          <p style="color: var(--text-secondary); margin-bottom: 15px;">Para n√£o perder dados: baixe o backup ou
            configure <code>BACKUP_WEBHOOK_URL</code> no Railway (envio autom√°tico a cada 6h).</p>
          <button type="button" class="btn btn-secondary" onclick="window.open('/api/backup', '_blank')"><i
              class="ri-download-line"></i> Download backup (JSON)</button>
          <button type="button" class="btn btn-secondary" style="margin-left: 10px;" onclick="sendBackup()"><i
              class="ri-send-plane-line"></i> Enviar backup agora</button>
          <span id="backupMsg" style="margin-left: 10px; font-size: 13px;"></span>
        </div>
      </div>
    </section>

    <!-- Usu√°rios (admin) -->
    <section id="users" class="section">
      <div class="header">
        <h2>Usu√°rios</h2>
        <button class="btn btn-primary" onclick="document.getElementById('userModal').classList.add('active')"><i
            class="ri-user-add-line"></i> Cadastrar usu√°rio</button>
      </div>
      <div class="card">
        <div class="card-header">
          <h3 class="card-title"><i class="ri-time-line"></i> Solicita√ß√µes pendentes (aguardando sua aprova√ß√£o)</h3>
        </div>
        <div class="card-body">
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Usu√°rio</th>
                  <th>Data da solicita√ß√£o</th>
                  <th>A√ß√µes</th>
                </tr>
              </thead>
              <tbody id="usersPendingTable">
                <tr>
                  <td colspan="3" class="loading">
                    <div class="spinner"></div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <p id="usersPendingEmpty" style="display:none; color: var(--text-secondary); padding: 15px 0;">Nenhuma
            solicita√ß√£o pendente.</p>
        </div>
      </div>
      <div class="card">
        <div class="card-header">
          <h3 class="card-title"><i class="ri-user-line"></i> Usu√°rios (ativos, pausados e bloqueados)</h3>
        </div>
        <div class="card-body">
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Usu√°rio</th>
                  <th>Perfil</th>
                  <th>Status</th>
                  <th>Criado em</th>
                  <th>A√ß√µes</th>
                </tr>
              </thead>
              <tbody id="usersTable">
                <tr>
                  <td colspan="5" class="loading">
                    <div class="spinner"></div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- Dom√≠nios (admin) -->
    <section id="domains" class="section">
      <div class="header">
        <h2>Meus dom√≠nios</h2>
        <button class="btn btn-primary" onclick="document.getElementById('domainModal').classList.add('active')"><i
            class="ri-add-line"></i> Cadastrar dom√≠nio</button>
      </div>
      <div class="card" style="border-left: 4px solid var(--primary);">
        <div class="card-body">
          <h4 style="margin-bottom: 10px;"><i class="ri-dns-line"></i> Configura√ß√£o DNS</h4>
          <p style="color: var(--text-secondary); margin-bottom: 14px;">Cada dom√≠nio cadastrado no Railway tem um
            <strong>Valor CNAME pr√≥prio</strong> (diferente do outro). Na tabela abaixo, use a coluna <strong>Valor
              CNAME</strong> da linha do dom√≠nio e configure no seu provedor de DNS (Cloudflare, Registro.br, etc.) ‚Äî
            Tipo: CNAME, Nome: <code>@</code>, Valor: o que aparece na coluna. N√£o precisa ir ao painel do Railway para
            pegar esses dados.
          </p>
          <p style="color: var(--text-secondary); font-size: 12px;">Se o dom√≠nio ainda n√£o tiver Valor CNAME (cadastrado
            antes da sincronia com Railway), use o valor gen√©rico: <code id="cnameTargetPlaceholder"
              style="font-size: 11px;">carregando...</code> <button type="button" class="btn btn-sm btn-secondary"
              onclick="copyCnameTarget()" style="margin-left:6px"><i class="ri-file-copy-line"></i> Copiar</button></p>
        </div>
      </div>
      <div class="card">
        <div class="card-body">
          <p style="color: var(--text-secondary); margin-bottom: 15px;">Lista de dom√≠nios. Para cada um, use o
            <strong>Valor CNAME</strong> da coluna abaixo no seu provedor de DNS (cada dom√≠nio pode ter um valor
            diferente).
          </p>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Descri√ß√£o</th>
                  <th>Dom√≠nio</th>
                  <th>Tipo</th>
                  <th>Nome</th>
                  <th>Valor CNAME</th>
                  <th>Propaga√ß√£o</th>
                  <th>A√ß√µes</th>
                </tr>
              </thead>
              <tbody id="domainsTable">
                <tr>
                  <td colspan="7" class="loading">
                    <div class="spinner"></div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <p id="domainsEmpty" style="display:none; color: var(--text-secondary); padding: 20px 0;">Nenhum dom√≠nio
            cadastrado. Clique em "Cadastrar dom√≠nio" para adicionar.</p>
        </div>
      </div>
    </section>

    <!-- P√°ginas HTML (landing customizadas) -->
    <section id="pages" class="section">
      <div class="header">
        <h2>Minhas P√°ginas</h2>
        <button class="btn btn-primary" onclick="openPageModal()"><i class="ri-add-line"></i> Nova p√°gina</button>
      </div>
      <p style="color: var(--text-secondary); margin-bottom: 20px;">Crie p√°ginas em HTML para exibir quando um visitante
        for bloqueado (em vez de redirecionar). Assim o visitante continua no mesmo dom√≠nio. Use em <strong>Meus
          Sites</strong> a op√ß√£o &quot;Usar minha p√°gina&quot; e escolha qual p√°gina exibir.</p>
      <div id="pagesList" class="info-grid" style="grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));">
        <div class="loading" style="grid-column: 1/-1;">
          <div class="spinner"></div>
        </div>
      </div>
      <p id="pagesEmpty" style="display:none; color: var(--text-secondary); padding: 20px 0;">Nenhuma p√°gina criada.
        Clique em &quot;Nova p√°gina&quot; para adicionar HTML customizado.</p>
    </section>
  </main>

  <!-- Modal P√°gina (criar/editar) -->
  <div class="modal" id="pageModal">
    <div class="modal-content" style="max-width: 700px;">
      <div class="modal-header">
        <h3 id="pageModalTitle">Nova p√°gina</h3>
        <button class="modal-close" onclick="closePageModal()">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="editPageId">
        <div class="form-group">
          <label class="form-label">Nome da p√°gina</label>
          <input type="text" class="form-input" id="pageName" placeholder="Ex: Manuten√ß√£o, P√°gina bloqueio">
        </div>
        <div class="form-group">
          <label class="form-label">HTML (c√≥digo completo da p√°gina)</label>
          <textarea class="form-input" id="pageHtml" rows="14"
            placeholder="&lt;!DOCTYPE html&gt;&#10;&lt;html&gt;&#10;&lt;head&gt;&lt;title&gt;...&lt;/title&gt;&lt;/head&gt;&#10;&lt;body&gt;...&lt;/body&gt;&lt;/html&gt;"
            style="font-family: monospace; font-size: 12px;"></textarea>
        </div>
        <div style="display: flex; gap: 10px; margin-top: 15px;">
          <button class="btn btn-primary" onclick="savePage()"><i class="ri-save-line"></i> Salvar</button>
          <button class="btn btn-secondary" onclick="closePageModal()">Cancelar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Cadastrar dom√≠nio -->
  <div class="modal" id="domainModal">
    <div class="modal-content" style="max-width: 450px;">
      <div class="modal-header">
        <h3>Cadastrar dom√≠nio</h3><button class="modal-close"
          onclick="document.getElementById('domainModal').classList.remove('active')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Descri√ß√£o (opcional)</label>
          <input type="text" class="form-input" id="newDomainDesc" placeholder="Ex: Campanha principal, Site X">
          <span style="font-size: 12px; color: var(--text-secondary);">Use para identificar este dom√≠nio na
            lista.</span>
        </div>
        <div class="form-group">
          <label class="form-label">Dom√≠nio (ex: cloaker.seudominio.com)</label>
          <input type="text" class="form-input" id="newDomainName" placeholder="cloaker.seudominio.com">
        </div>
        <button class="btn btn-primary" onclick="addDomain()"><i class="ri-save-line"></i> Cadastrar</button>
        <span id="domainMsg" style="margin-left: 10px; font-size: 13px;"></span>
      </div>
    </div>
  </div>

  <!-- Modal Alterar senha (admin) -->
  <div class="modal" id="changePasswordModal">
    <div class="modal-content" style="max-width: 400px;">
      <div class="modal-header">
        <h3>Alterar senha</h3>
        <button class="modal-close" onclick="closeChangePasswordModal()">&times;</button>
      </div>
      <div class="modal-body">
        <p style="margin-bottom:15px;color:var(--text-secondary)">Usu√°rio: <strong id="changePasswordUsername"></strong>
        </p>
        <div class="form-group">
          <label class="form-label">Nova senha (m√≠n. 6 caracteres)</label>
          <input type="password" class="form-input" id="changePasswordNew" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        </div>
        <button class="btn btn-primary" onclick="submitChangePassword()"><i class="ri-save-line"></i> Salvar</button>
        <button class="btn btn-secondary" onclick="closeChangePasswordModal()"
          style="margin-left:10px">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Modal Novo usu√°rio -->
  <div class="modal" id="userModal">
    <div class="modal-content" style="max-width: 450px;">
      <div class="modal-header">
        <h3>Novo usu√°rio</h3>
        <button class="modal-close"
          onclick="document.getElementById('userModal').classList.remove('active')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Usu√°rio</label>
          <input type="text" class="form-input" id="newUserUsername" placeholder="nome de login">
        </div>
        <div class="form-group">
          <label class="form-label">Senha (m√≠n. 6 caracteres)</label>
          <input type="password" class="form-input" id="newUserPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        </div>
        <div class="form-group">
          <label class="form-label">Perfil</label>
          <select class="form-select" id="newUserRole">
            <option value="user">Usu√°rio</option>
            <option value="admin">Administrador</option>
          </select>
        </div>
        <button class="btn btn-primary" onclick="createUser()"><i class="ri-save-line"></i> Criar</button>
        <span id="userMsg" style="margin-left: 10px; font-size: 13px;"></span>
      </div>
    </div>
  </div>

  <!-- Modal Novo/Editar Site -->
  <div class="modal" id="siteModal">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h3 id="siteModalTitle">Novo Site</h3>
        <button class="modal-close" onclick="closeSiteModal()">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="editSiteId">
        <div class="form-group">
          <label class="form-label">Nome do Site</label>
          <input type="text" class="form-input" id="siteName" placeholder="Ex: Landing Page Produto X">
        </div>
        <div class="form-group">
          <label class="form-label">URL do seu site (landing page)</label>
          <input type="url" class="form-input" id="siteTargetUrl" placeholder="https://meusite.com/landing" required>
          <small style="color: var(--text-secondary); font-size: 12px;">Link real da sua p√°gina. Quem for permitido vai
            para esse link.</small>
        </div>
        <div class="form-group">
          <label class="form-label">Dom√≠nio (opcional)</label>
          <input type="text" class="form-input" id="siteDomain" placeholder="Ex: meuproduto.com">
        </div>
        <div class="form-group">
          <label class="form-label">Dom√≠nio preferido para o link</label>
          <select class="form-select" id="siteSelectedDomain">
            <option value="">Padr√£o</option>
          </select>
          <small style="color: var(--text-secondary); font-size: 12px;">Salve o site para manter este dom√≠nio; n√£o volta
            para o padr√£o ao atualizar.</small>
        </div>
        <div class="form-group">
          <label class="form-label">URL de Redirecionamento (quando bloquear)</label>
          <input type="text" class="form-input" id="siteRedirectUrl" value="https://www.google.com/"
            placeholder="Para onde mandar quem for bloqueado">
          <div class="form-group" style="margin-top: 12px;">
            <label class="form-label">Ao bloquear, o que fazer?</label>
            <div style="display: flex; flex-direction: column; gap: 8px;">
              <label class="radio-label"><input type="radio" name="siteBlockBehavior" id="siteBlockBehaviorRedirect"
                  value="redirect" checked> Redirecionar para a URL acima</label>
              <label class="radio-label"><input type="radio" name="siteBlockBehavior" id="siteBlockBehaviorEmbed"
                  value="embed"> Mostrar o conte√∫do da URL nesta mesma p√°gina (embed)</label>
              <label class="radio-label"><input type="radio" name="siteBlockBehavior" id="siteBlockBehaviorPage"
                  value="page"> Usar minha p√°gina (HTML definido em P√°ginas ‚Äî fica no mesmo dom√≠nio)</label>
            </div>
          </div>
          <div id="sitePageSelectBox"
            style="display: none; margin-top: 10px; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
            <label class="form-label" style="margin-bottom: 6px;">Qual p√°gina usar?</label>
            <select class="form-select" id="siteLandingPageId">
              <option value="">‚Äî Selecione ‚Äî</option>
            </select>
          </div>
        </div>
        <h4 style="margin: 25px 0 15px;">Regras de Bloqueio</h4>
        <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 15px;">Padr√£o: <strong>apenas Brasil
            (BR)</strong>; bloquear desktops, Facebook, bots, VPN/proxy e DevTools.</p>
        <div class="info-grid">
          <div class="info-item"><span class="info-label">Bloquear Desktops</span><label class="switch"><input
                type="checkbox" id="siteBlockDesktop" checked><span class="slider"></span></label></div>
          <div class="info-item"><span class="info-label">Bloquear Biblioteca Facebook</span><label
              class="switch"><input type="checkbox" id="siteBlockFacebook" checked><span class="slider"></span></label>
          </div>
          <div class="info-item"><span class="info-label">Bloquear Bots</span><label class="switch"><input
                type="checkbox" id="siteBlockBots" checked><span class="slider"></span></label></div>
          <div class="info-item"><span class="info-label">Bloquear VPN/Proxy</span><label class="switch"><input
                type="checkbox" id="siteBlockVpn" checked><span class="slider"></span></label></div>
          <div class="info-item"><span class="info-label">Bloquear DevTools</span><label class="switch"><input
                type="checkbox" id="siteBlockDevtools" checked><span class="slider"></span></label></div>
        </div>
        <div class="form-group" style="margin-top: 20px;">
          <div class="country-select-wrap">
            <div class="form-group">
              <label class="form-label">Pa√≠ses Permitidos</label>
              <div class="country-actions">
                <button type="button" class="country-action-btn" onclick="toggleAllCountries('allowed', true)">Marcar
                  todos</button>
                <button type="button" class="country-action-btn"
                  onclick="toggleAllCountries('allowed', false)">Desmarcar todos</button>
              </div>
              <div class="country-checkbox-container" id="siteAllowedCountries"></div>
              <p class="form-hint">Padr√£o: apenas Brasil (BR). Marque todos se quiser permitir qualquer pa√≠s.</p>
            </div>
            <div class="form-group">
              <label class="form-label">Pa√≠ses Bloqueados</label>
              <div class="country-actions">
                <button type="button" class="country-action-btn" onclick="toggleAllCountries('blocked', true)">Marcar
                  todos</button>
                <button type="button" class="country-action-btn"
                  onclick="toggleAllCountries('blocked', false)">Desmarcar todos</button>
              </div>
              <div class="country-checkbox-container" id="siteBlockedCountries"></div>
              <p class="form-hint">Deixe vazio para n√£o bloquear nenhum pa√≠s.</p>
            </div>
          </div>
        </div>
        <h4 style="margin: 25px 0 15px;">Par√¢metro de rastreamento (Meta Ads)</h4>
        <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 12px;">Para permitir
          <strong>apenas</strong> quem clicar no an√∫ncio: exija o par√¢metro abaixo. No Meta Ads, em <strong>Rastreamento
            ‚Üí Par√¢metros de URL</strong>, adicione o valor. Quem acessar o link sem esse par√¢metro ser√° bloqueado.
        </p>
        <div class="info-grid" style="margin-bottom: 12px;">
          <div class="info-item" style="flex: 1 1 100%;">
            <span class="info-label">Exigir par√¢metro de rastreamento (bloquear quem n√£o vier do Ads)</span>
            <label class="switch"><input type="checkbox" id="siteRequireRef"><span class="slider"></span></label>
          </div>
        </div>
        <div id="siteRefTokenBox"
          style="display: none; background: var(--bg-secondary); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
          <div class="form-label" style="margin-bottom: 8px;">Par√¢metro para colar no Meta Ads (Par√¢metros de URL):
          </div>
          <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
            <code id="siteRefTokenValue"
              style="padding: 8px 12px; background: var(--bg-primary); border-radius: 8px; font-size: 13px; word-break: break-all;"></code>
            <button type="button" class="btn btn-sm btn-secondary" onclick="copyRefToken()"><i
                class="ri-file-copy-line"></i> Copiar</button>
            <button type="button" class="btn btn-sm btn-secondary" id="siteRegenerateRefBtn"
              onclick="setRegenerateRefOnSave(true)"><i class="ri-refresh-line"></i> Gerar novo token</button>
          </div>
        </div>
        <div class="form-group" style="margin-top: 15px;">
          <label class="form-label">Par√¢metros padr√£o no link (opcional)</label>
          <input type="text" class="form-input" id="siteDefaultLinkParams"
            placeholder="Ex: utm_source=facebook&utm_medium=cpc&utm_campaign=campanha1">
          <p class="form-hint">Ser√£o inclu√≠dos no link ao copiar. Ex: <code>utm_source=fb&utm_medium=cpc</code>. O
            <code>ref=</code> (se exigir) √© adicionado automaticamente.
          </p>
        </div>
        <div style="display: flex; gap: 10px; margin-top: 25px;">
          <button class="btn btn-primary" onclick="saveSite()"><i class="ri-save-line"></i> Salvar</button>
          <button class="btn btn-secondary" onclick="closeSiteModal()">Cancelar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Detalhes Visitante -->
  <div class="modal" id="visitorModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Detalhes do Visitante</h3><button class="modal-close" onclick="closeVisitorModal()">&times;</button>
      </div>
      <div class="modal-body" id="visitorDetails">
        <div class="loading">
          <div class="spinner"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentPeriod = 'today';
    let currentFilter = 'all';
    let currentPage = 1;
    let permittedPage = 1;
    let blockedPage = 1;
    let charts = {};
    let sites = [];
    let currentUser = null;
    let baseUrlOrOrigin = window.location.origin;
    let systemDefaultDomain = null;

    const COUNTRY_LIST = [
      { code: 'BR', name: 'Brasil' }, { code: 'AR', name: 'Argentina' }, { code: 'BO', name: 'Bol√≠via' }, { code: 'CL', name: 'Chile' },
      { code: 'CO', name: 'Col√¥mbia' }, { code: 'EC', name: 'Equador' }, { code: 'PY', name: 'Paraguai' }, { code: 'PE', name: 'Peru' },
      { code: 'UY', name: 'Uruguai' }, { code: 'VE', name: 'Venezuela' }, { code: 'US', name: 'Estados Unidos' }, { code: 'CA', name: 'Canad√°' },
      { code: 'MX', name: 'M√©xico' }, { code: 'PT', name: 'Portugal' }, { code: 'ES', name: 'Espanha' }, { code: 'GB', name: 'Reino Unido' },
      { code: 'FR', name: 'Fran√ßa' }, { code: 'DE', name: 'Alemanha' }, { code: 'IT', name: 'It√°lia' }, { code: 'NL', name: 'Holanda' },
      { code: 'BE', name: 'B√©lgica' }, { code: 'CH', name: 'Su√≠√ßa' }, { code: 'AT', name: '√Åustria' }, { code: 'PL', name: 'Pol√¥nia' },
      { code: 'RU', name: 'R√∫ssia' }, { code: 'UA', name: 'Ucr√¢nia' }, { code: 'TR', name: 'Turquia' }, { code: 'IN', name: '√çndia' },
      { code: 'CN', name: 'China' }, { code: 'JP', name: 'Jap√£o' }, { code: 'KR', name: 'Coreia do Sul' }, { code: 'AU', name: 'Austr√°lia' },
      { code: 'ZA', name: '√Åfrica do Sul' }, { code: 'EG', name: 'Egito' }, { code: 'NG', name: 'Nig√©ria' }, { code: 'KE', name: 'Qu√™nia' },
      { code: 'SA', name: 'Ar√°bia Saudita' }, { code: 'AE', name: 'Emirados √Årabes' }, { code: 'IL', name: 'Israel' }, { code: 'TH', name: 'Tail√¢ndia' },
      { code: 'VN', name: 'Vietn√£' }, { code: 'ID', name: 'Indon√©sia' }, { code: 'MY', name: 'Mal√°sia' }, { code: 'PH', name: 'Filipinas' },
      { code: 'SE', name: 'Su√©cia' }, { code: 'NO', name: 'Noruega' }, { code: 'DK', name: 'Dinamarca' }, { code: 'FI', name: 'Finl√¢ndia' },
      { code: 'IE', name: 'Irlanda' }, { code: 'GR', name: 'Gr√©cia' }, { code: 'CZ', name: 'Rep. Tcheca' }, { code: 'RO', name: 'Rom√™nia' },
      { code: 'HU', name: 'Hungria' }, { code: 'BG', name: 'Bulg√°ria' }, { code: 'HR', name: 'Cro√°cia' }, { code: 'RS', name: 'S√©rvia' },
      { code: 'CR', name: 'Costa Rica' }, { code: 'PA', name: 'Panam√°' }, { code: 'GT', name: 'Guatemala' }, { code: 'DO', name: 'Rep. Dominicana' },
      { code: 'CU', name: 'Cuba' }, { code: 'PR', name: 'Porto Rico' }, { code: 'JM', name: 'Jamaica' }, { code: 'HN', name: 'Honduras' },
      { code: 'SV', name: 'El Salvador' }, { code: 'NI', name: 'Nicar√°gua' }, { code: 'NZ', name: 'Nova Zel√¢ndia' }, { code: 'SG', name: 'Singapura' },
      { code: 'PK', name: 'Paquist√£o' }, { code: 'BD', name: 'Bangladesh' }, { code: 'IR', name: 'Ir√£' }, { code: 'IQ', name: 'Iraque' }
    ];

    function fillCountrySelects() {
      const item = (c, type) => '<div class="country-checkbox-item" data-code="' + c.code + '" data-type="' + type + '"><input type="checkbox" id="country-' + type + '-' + c.code + '" value="' + c.code + '"><label for="country-' + type + '-' + c.code + '">' + c.name + ' (' + c.code + ')</label></div>';
      const allowed = document.getElementById('siteAllowedCountries');
      const blocked = document.getElementById('siteBlockedCountries');
      if (allowed && blocked) {
        allowed.innerHTML = COUNTRY_LIST.map(c => item(c, 'allowed')).join('');
        blocked.innerHTML = COUNTRY_LIST.map(c => item(c, 'blocked')).join('');
        updateCountryVisibility();
        allowed.querySelectorAll('input[type="checkbox"]').forEach(cb => {
          cb.addEventListener('change', updateCountryVisibility);
        });
        blocked.querySelectorAll('input[type="checkbox"]').forEach(cb => {
          cb.addEventListener('change', updateCountryVisibility);
        });
      }
    }

    function updateCountryVisibility() {
      const allowed = document.getElementById('siteAllowedCountries');
      const blocked = document.getElementById('siteBlockedCountries');
      if (!allowed || !blocked) return;
      const allowedChecked = Array.from(allowed.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
      const blockedChecked = Array.from(blocked.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
      blocked.querySelectorAll('.country-checkbox-item').forEach(item => {
        const code = item.dataset.code;
        if (allowedChecked.includes(code)) {
          item.style.display = 'none';
          const cb = item.querySelector('input[type="checkbox"]');
          if (cb) cb.checked = false;
        } else {
          item.style.display = '';
        }
      });
      allowed.querySelectorAll('.country-checkbox-item').forEach(item => {
        const code = item.dataset.code;
        if (blockedChecked.includes(code)) {
          item.style.display = 'none';
          const cb = item.querySelector('input[type="checkbox"]');
          if (cb) cb.checked = false;
        } else {
          item.style.display = '';
        }
      });
    }

    function setCountrySelect(elId, codesStr) {
      const el = document.getElementById(elId);
      if (!el) return;
      const codes = (codesStr || '').split(',').map(c => c.trim().toUpperCase()).filter(Boolean);
      const checkboxes = el.querySelectorAll('input[type="checkbox"]');
      checkboxes.forEach(cb => { cb.checked = codes.indexOf(cb.value) !== -1; });
    }

    function getCountrySelectValue(elId) {
      const el = document.getElementById(elId);
      if (!el) return '';
      const checkboxes = el.querySelectorAll('input[type="checkbox"]:checked');
      return Array.from(checkboxes).map(cb => cb.value).join(',');
    }

    function toggleAllCountries(type, checked) {
      const elId = type === 'allowed' ? 'siteAllowedCountries' : 'siteBlockedCountries';
      const el = document.getElementById(elId);
      if (!el) return;
      const checkboxes = el.querySelectorAll('.country-checkbox-item:not([style*="display: none"]) input[type="checkbox"]');
      checkboxes.forEach(cb => { cb.checked = checked; });
      updateCountryVisibility();
    }

    function getBaseUrl() { return (baseUrlOrOrigin || '').replace(/\/$/, '') || window.location.origin; }

    function checkAuth(res) {
      if (res && res.status === 401) { window.location.href = '/login'; return true; }
      return false;
    }

    async function apiGet(url) {
      const res = await fetch(url, { credentials: 'include' });
      if (checkAuth(res)) return null;
      return res;
    }

    // Hor√°rio de Bras√≠lia (America/Sao_Paulo) ‚Äì datas da API s√£o tratadas como UTC
    const TZ_BR = 'America/Sao_Paulo';
    function toDateBR(d) {
      if (!d) return null;
      var s = typeof d === 'string' ? d : d;
      if (typeof s === 'string' && !/Z|[+-]\d{2}:?\d{2}$/.test(s)) s = s.replace(' ', 'T') + 'Z';
      return new Date(s);
    }
    function formatDateBR(d) {
      var date = toDateBR(d);
      return date ? date.toLocaleString('pt-BR', { timeZone: TZ_BR, dateStyle: 'short', timeStyle: 'short' }) : '-';
    }
    function formatDateTimeBR(d) {
      var date = toDateBR(d);
      return date ? date.toLocaleString('pt-BR', { timeZone: TZ_BR, day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' }) : '-';
    }

    // Navigation
    document.querySelectorAll('.nav-link').forEach(link => {
      link.addEventListener('click', () => {
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        link.classList.add('active');
        const section = link.dataset.section;
        document.getElementById(section).classList.add('active');
        if (section === 'dashboard') refreshStats();
        if (section === 'sites') { loadSites(); loadPages(); }
        if (section === 'visitors') loadVisitors();
        if (section === 'reports') loadReports();
        if (section === 'domains') loadDomains();
        if (section === 'pages') loadPages();
        if (section === 'script') loadScriptSection();
        if (section === 'settings') loadSettings();
        if (section === 'users') loadUsers();
      });
    });

    document.querySelectorAll('.period-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentPeriod = btn.dataset.period;
        refreshStats();
      });
    });

    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentFilter = btn.dataset.filter;
        currentPage = 1;
        loadVisitors();
      });
    });

    // Sites
    async function loadSites() {
      try {
        const res = await apiGet('/api/sites');
        if (!res) return;
        const data = await res.json();
        sites = Array.isArray(data) ? data : [];
        try {
          const dr = await apiGet('/api/domains');
          if (dr) {
            const ddata = await dr.json();
            domainsList = ddata.domains || [];
            systemDefaultDomain = ddata.defaultDomain || null;
          }
        } catch (e) { domainsList = []; }
        updateSiteSelectors();
        renderSitesList();
      } catch (e) { sites = []; domainsList = []; updateSiteSelectors(); renderSitesList(); }
    }

    function updateSiteSelectors() {
      if (!Array.isArray(sites)) sites = [];
      const selectors = ['dashboardSiteFilter', 'visitorsSiteFilter', 'reportsSiteFilter', 'scriptSiteSelector'];
      selectors.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        const currentVal = el.value;
        if (id === 'scriptSiteSelector') {
          el.innerHTML = '<option value="">Selecione um site...</option>' + sites.map(s => `<option value="${s.site_id}">${s.name}</option>`).join('');
        } else {
          el.innerHTML = '<option value="all">Todos os Sites</option>' + sites.map(s => `<option value="${s.site_id}">${s.name}</option>`).join('');
        }
        el.value = currentVal || (id === 'scriptSiteSelector' ? '' : 'all');
      });
    }

    function renderSitesList() {
      const container = document.getElementById('sitesList');
      if (sites.length === 0) {
        container.innerHTML = `<div class="empty-state"><i class="ri-global-line"></i><h3>Nenhum site cadastrado</h3><p>Clique em "Novo Site" para come√ßar</p></div>`;
        return;
      }
      container.innerHTML = sites.map(s => `
        <div class="site-card">
          <div class="site-card-header">
            <div>
              <div class="site-card-title">${s.name}</div>
              <div class="site-card-domain">${s.domain || 'Sem dom√≠nio'}</div>
            </div>
            <div style="display: flex; gap: 10px;">
              <button class="btn btn-secondary btn-sm" onclick="editSite('${s.site_id}')"><i class="ri-edit-line"></i></button>
              <button class="btn btn-danger btn-sm" onclick="deleteSite('${s.site_id}')"><i class="ri-delete-bin-line"></i></button>
            </div>
          </div>
          <div class="site-card-stats">
            <div class="site-card-stat"><div class="site-card-stat-value">${s.total_visits || 0}</div><div class="site-card-stat-label">Visitas</div></div>
            <div class="site-card-stat"><div class="site-card-stat-value" style="color: var(--danger)">${s.blocked_visits || 0}</div><div class="site-card-stat-label">Bloqueados</div></div>
            <div class="site-card-stat"><div class="site-card-stat-value" style="color: var(--success)">${(s.total_visits || 0) - (s.blocked_visits || 0)}</div><div class="site-card-stat-label">Permitidos</div></div>
          </div>
          <div style="margin-top: 15px;">
            <div class="form-label" style="margin-bottom: 6px;">üîó Link para usar nos Ads (Meta Ads, etc.)</div>
            <div style="margin-bottom: 8px;">
              <label class="form-label" style="margin-bottom: 4px; font-size: 12px;">Usar dom√≠nio:</label>
              <select class="form-select" id="domainSelect-${s.site_id}" style="max-width: 280px;" onchange="updateSiteLinkDisplays('${s.site_id}')">
                <option value="" ${!s.selected_domain ? 'selected' : ''}>Padr√£o</option>
                ${(domainsList || []).map(d => '<option value="' + (d.domain || '') + '" ' + (s.selected_domain === d.domain ? 'selected' : '') + '>' + (d.domain || '') + '</option>').join('')}
              </select>
            </div>
            <div class="form-label" style="margin: 10px 0 4px; font-size: 12px;">Dom√≠nio gerado</div>
            <div class="code-block" style="font-size: 12px; padding: 10px;">
              <button class="copy-btn" style="padding: 4px 8px; font-size: 10px;" onclick="copySiteLinkBase('${s.site_id}')"><i class="ri-file-copy-line"></i> Copiar</button>
              <span id="linkBase-${s.site_id}">${s.link_code ? buildLinkBase(s, s.selected_domain ? getLinkBaseUrl(s.selected_domain) : getBaseUrl()) : '‚Äî'}</span>
            </div>
            <div class="form-label" style="margin: 10px 0 4px; font-size: 12px;">Par√¢metros</div>
            <div class="code-block" style="font-size: 12px; padding: 10px;">
              <button class="copy-btn" style="padding: 4px 8px; font-size: 10px;" onclick="copySiteLinkParams('${s.site_id}')"><i class="ri-file-copy-line"></i> Copiar</button>
              <span id="linkParams-${s.site_id}">${s.link_code ? (buildLinkParams(s) || '‚Äî') : '‚Äî'}</span>
            </div>
            <p style="color: var(--text-secondary); font-size: 12px; margin-top: 8px;">Copie o <strong>dom√≠nio gerado</strong> e os <strong>par√¢metros</strong> separadamente, ou use o link completo nos an√∫ncios.</p>
          </div>
        </div>
      `).join('');
    }

    let regenerateRefOnSave = false;

    function openNewSiteModal() {
      document.getElementById('siteModalTitle').textContent = 'Novo Site';
      document.getElementById('editSiteId').value = '';
      document.getElementById('siteName').value = '';
      document.getElementById('siteDomain').value = '';
      document.getElementById('siteTargetUrl').value = '';
      document.getElementById('siteRedirectUrl').value = 'https://www.google.com/';
      document.getElementById('siteBlockBehaviorRedirect').checked = true;
      document.getElementById('siteBlockBehaviorEmbed').checked = false;
      document.getElementById('siteBlockBehaviorPage').checked = false;
      document.getElementById('sitePageSelectBox').style.display = 'none';
      fillSiteModalDomainsAndPages();
      document.getElementById('siteSelectedDomain').value = '';
      document.getElementById('siteLandingPageId').value = '';
      document.getElementById('siteBlockDesktop').checked = true;
      document.getElementById('siteBlockFacebook').checked = true;
      document.getElementById('siteBlockBots').checked = true;
      document.getElementById('siteBlockVpn').checked = true;
      document.getElementById('siteBlockDevtools').checked = true;
      setCountrySelect('siteAllowedCountries', 'BR');
      setCountrySelect('siteBlockedCountries', '');
      updateCountryVisibility();
      document.getElementById('siteRequireRef').checked = false;
      document.getElementById('siteRefTokenBox').style.display = 'none';
      document.getElementById('siteDefaultLinkParams').value = '';
      regenerateRefOnSave = false;
      document.getElementById('siteModal').classList.add('active');
    }

    function fillSiteModalDomainsAndPages() {
      const selDomain = document.getElementById('siteSelectedDomain');
      const defaultLabel = systemDefaultDomain ? `Padr√£o (${systemDefaultDomain})` : 'Padr√£o (URL do Painel)';
      if (selDomain) selDomain.innerHTML = `<option value="">${defaultLabel}</option>` + (domainsList || []).map(d => '<option value="' + (d.domain || '') + '">' + (d.domain || '') + '</option>').join('');
      const selPage = document.getElementById('siteLandingPageId');
      if (selPage) selPage.innerHTML = '<option value="">‚Äî Selecione ‚Äî</option>' + (pagesList || []).map(p => '<option value="' + p.id + '">' + (p.name || 'P√°gina ' + p.id) + '</option>').join('');
    }

    function editSite(siteId) {
      const site = sites.find(s => s.site_id === siteId);
      if (!site) return;
      document.getElementById('siteModalTitle').textContent = 'Editar Site';
      document.getElementById('editSiteId').value = siteId;
      document.getElementById('siteName').value = site.name;
      document.getElementById('siteDomain').value = site.domain || '';
      document.getElementById('siteTargetUrl').value = site.target_url || '';
      document.getElementById('siteRedirectUrl').value = site.redirect_url || 'https://www.google.com/';
      const behavior = site.block_behavior || 'redirect';
      const isEmbed = behavior === 'embed';
      const isPage = behavior === 'page';
      document.getElementById('siteBlockBehaviorRedirect').checked = !isEmbed && !isPage;
      document.getElementById('siteBlockBehaviorEmbed').checked = isEmbed;
      document.getElementById('siteBlockBehaviorPage').checked = isPage;
      document.getElementById('sitePageSelectBox').style.display = isPage ? 'block' : 'none';
      fillSiteModalDomainsAndPages();
      document.getElementById('siteSelectedDomain').value = site.selected_domain || '';
      document.getElementById('siteLandingPageId').value = site.landing_page_id || '';
      document.getElementById('siteBlockDesktop').checked = site.block_desktop;
      document.getElementById('siteBlockFacebook').checked = site.block_facebook_library;
      document.getElementById('siteBlockBots').checked = site.block_bots;
      document.getElementById('siteBlockVpn').checked = site.block_vpn;
      document.getElementById('siteBlockDevtools').checked = site.block_devtools;
      setCountrySelect('siteAllowedCountries', site.allowed_countries || 'BR');
      setCountrySelect('siteBlockedCountries', site.blocked_countries || '');
      updateCountryVisibility();
      const hasRef = !!(site.required_ref_token && site.required_ref_token.trim());
      document.getElementById('siteRequireRef').checked = hasRef;
      const refBox = document.getElementById('siteRefTokenBox');
      if (hasRef) {
        refBox.style.display = 'block';
        document.getElementById('siteRefTokenValue').textContent = 'ref=' + site.required_ref_token;
      } else {
        refBox.style.display = 'block';
        document.getElementById('siteRefTokenValue').textContent = '(nenhum ‚Äì marque "Exigir" e salve para gerar)';
      }
      document.getElementById('siteDefaultLinkParams').value = (site.default_link_params || '').trim();
      regenerateRefOnSave = false;
      document.getElementById('siteModal').classList.add('active');
    }

    function setRegenerateRefOnSave(v) { regenerateRefOnSave = v; }

    function copyRefToken() {
      const code = document.getElementById('siteRefTokenValue');
      if (!code || !code.textContent || code.textContent.startsWith('(nenhum')) return;
      const text = code.textContent.trim();
      if (text) { copyToClipboard(text); }
    }

    async function saveSite() {
      const siteId = document.getElementById('editSiteId').value;
      const requireRef = document.getElementById('siteRequireRef').checked;
      const isPageBehavior = document.getElementById('siteBlockBehaviorPage').checked;
      const data = {
        name: document.getElementById('siteName').value,
        domain: document.getElementById('siteDomain').value,
        target_url: document.getElementById('siteTargetUrl').value,
        redirect_url: document.getElementById('siteRedirectUrl').value,
        block_behavior: isPageBehavior ? 'page' : (document.getElementById('siteBlockBehaviorEmbed').checked ? 'embed' : 'redirect'),
        landing_page_id: isPageBehavior ? (document.getElementById('siteLandingPageId').value || null) : null,
        selected_domain: document.getElementById('siteSelectedDomain').value || null,
        default_link_params: (document.getElementById('siteDefaultLinkParams').value || '').trim(),
        block_desktop: document.getElementById('siteBlockDesktop').checked,
        block_facebook_library: document.getElementById('siteBlockFacebook').checked,
        block_bots: document.getElementById('siteBlockBots').checked,
        block_devtools: document.getElementById('siteBlockDevtools').checked,
        block_vpn: document.getElementById('siteBlockVpn').checked,
        allowed_countries: getCountrySelectValue('siteAllowedCountries') || 'BR',
        blocked_countries: getCountrySelectValue('siteBlockedCountries') || '',
        is_active: true
      };
      if (siteId) {
        if (!requireRef) data.required_ref_token = '';
        else if (regenerateRefOnSave) data.regenerate_ref_token = true;
        else {
          const site = sites.find(s => s.site_id === siteId);
          if (site && !(site.required_ref_token && site.required_ref_token.trim())) data.regenerate_ref_token = true;
        }
      }
      regenerateRefOnSave = false;

      if (!data.name) { alert('Digite um nome para o site'); return; }
      if (!data.target_url || !data.target_url.trim()) { alert('Digite a URL do seu site (landing page)'); return; }

      try {
        if (siteId) {
          await fetch(`/api/sites/${siteId}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, credentials: 'include', body: JSON.stringify(data) });
        } else {
          await fetch('/api/sites', { method: 'POST', headers: { 'Content-Type': 'application/json' }, credentials: 'include', body: JSON.stringify(data) });
        }
        closeSiteModal();
        loadSites();
      } catch (e) { alert('Erro ao salvar site'); }
    }

    async function deleteSite(siteId) {
      if (!confirm('Tem certeza? Todos os dados de visitantes deste site ser√£o perdidos!')) return;
      try {
        await fetch(`/api/sites/${siteId}`, { method: 'DELETE', credentials: 'include' });
        loadSites();
      } catch (e) { alert('Erro ao deletar site'); }
    }

    function closeSiteModal() { document.getElementById('siteModal').classList.remove('active'); }

    // Stats
    async function refreshStats() {
      const siteId = document.getElementById('dashboardSiteFilter') ? document.getElementById('dashboardSiteFilter').value : 'all';
      try {
        const res = await apiGet(`/api/stats?period=${currentPeriod}&site=${siteId}`);
        if (!res) return;
        const stats = await res.json();
        if (!stats || typeof stats !== 'object') return;
        const n = (v) => (v == null || isNaN(v) ? 0 : Number(v));
        document.getElementById('statTotal').textContent = (n(stats.total)).toLocaleString();
        document.getElementById('statAllowed').textContent = (n(stats.allowed)).toLocaleString();
        document.getElementById('statBlocked').textContent = (n(stats.blocked)).toLocaleString();
        document.getElementById('statBots').textContent = (n(stats.bots)).toLocaleString();
        document.getElementById('statMobile').textContent = (n(stats.mobile)).toLocaleString();
        document.getElementById('statDesktop').textContent = (n(stats.desktop)).toLocaleString();
        updateCharts(stats);
        loadLastVisits();
        var lastEl = document.getElementById('dashboardLastUpdate');
        if (lastEl) lastEl.textContent = '√öltima atualiza√ß√£o: ' + new Date().toLocaleString('pt-BR', { timeZone: 'America/Sao_Paulo', dateStyle: 'short', timeStyle: 'medium' }) + ' (Bras√≠lia)';
      } catch (e) { }
    }

    async function loadLastVisits() {
      const siteId = document.getElementById('dashboardSiteFilter') ? document.getElementById('dashboardSiteFilter').value : 'all';
      const tbody = document.getElementById('lastVisitsTable');
      if (!tbody) return;
      try {
        const res = await apiGet(`/api/visitors?page=1&limit=10&filter=all&site=${siteId}`);
        if (!res) return;
        const data = await res.json();
        const list = Array.isArray(data && data.visitors) ? data.visitors : [];
        if (list.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:30px;color:var(--text-secondary)">Nenhum acesso ainda</td></tr>';
          return;
        }
        tbody.innerHTML = list.map(v => `
          <tr>
            <td>${formatDateTimeBR(v.created_at)}</td>
            <td><code style="font-size:11px">${v.ip || '-'}</code></td>
            <td><span class="badge badge-info">${v.site_id || 'default'}</span></td>
            <td>${v.was_blocked ? '<span class="badge badge-danger">Bloqueado</span>' : '<span class="badge badge-success">Permitido</span>'}</td>
            <td>${v.country || '-'}</td>
            <td><i class="ri-${v.device_type === 'mobile' ? 'smartphone' : 'computer'}-line"></i> ${v.device_type || 'desktop'}</td>
            <td title="${(v.block_reason || '').replace(/"/g, '')}">${v.block_reason ? (v.block_reason.length > 25 ? v.block_reason.substring(0, 25) + '...' : v.block_reason) : '-'}</td>
            <td><button class="btn btn-secondary btn-sm" onclick="viewVisitor(${v.id})"><i class="ri-eye-line"></i></button></td>
          </tr>
        `).join('');
      } catch (e) { tbody.innerHTML = '<tr><td colspan="8" style="color:var(--danger)">Erro ao carregar</td></tr>'; }
    }

    function updateCharts(stats) {
      if (!stats || typeof stats !== 'object') return;
      const colors = { line: ['#00d9a5', '#e94560'], pie: ['#e94560', '#00d9a5', '#ffc107', '#17a2b8', '#6f42c1', '#fd7e14'] };
      const chartOpts = { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: '#a0a0b0' } } } };
      const arr = (x) => Array.isArray(x) ? x : [];
      const byHour = arr(stats.byHour);
      const hourlyData = byHour.slice().reverse();
      if (charts.hourly) charts.hourly.destroy();
      charts.hourly = new Chart(document.getElementById('chartHourly'), {
        type: 'line',
        data: {
          labels: hourlyData.map(h => h.hour?.split(' ')[1] || h.hour),
          datasets: [
            { label: 'Permitidos', data: hourlyData.map(h => h.allowed), borderColor: colors.line[0], backgroundColor: 'rgba(0,217,165,0.1)', fill: true, tension: 0.4 },
            { label: 'Bloqueados', data: hourlyData.map(h => h.blocked), borderColor: colors.line[1], backgroundColor: 'rgba(233,69,96,0.1)', fill: true, tension: 0.4 }
          ]
        },
        options: { ...chartOpts, scales: { x: { ticks: { color: '#a0a0b0' }, grid: { color: '#2a2a4a' } }, y: { ticks: { color: '#a0a0b0' }, grid: { color: '#2a2a4a' } } } }
      });

      // Browser
      if (charts.browser) charts.browser.destroy();
      charts.browser = new Chart(document.getElementById('chartBrowser'), {
        type: 'doughnut',
        data: { labels: arr(stats.byBrowser).map(b => b.browser || 'N/A'), datasets: [{ data: arr(stats.byBrowser).map(b => b.count), backgroundColor: colors.pie }] },
        options: { ...chartOpts, plugins: { legend: { position: 'right', labels: { color: '#a0a0b0' } } } }
      });

      // Country
      if (charts.country) charts.country.destroy();
      charts.country = new Chart(document.getElementById('chartCountry'), {
        type: 'bar',
        data: { labels: arr(stats.byCountry).map(c => c.country || 'N/A'), datasets: [{ label: 'Visitas', data: arr(stats.byCountry).map(c => c.count), backgroundColor: '#e94560' }] },
        options: { ...chartOpts, plugins: { legend: { display: false } }, scales: { x: { ticks: { color: '#a0a0b0' }, grid: { color: '#2a2a4a' } }, y: { ticks: { color: '#a0a0b0' }, grid: { color: '#2a2a4a' } } } }
      });

      // Block Reasons
      if (charts.blockReasons) charts.blockReasons.destroy();
      charts.blockReasons = new Chart(document.getElementById('chartBlockReasons'), {
        type: 'pie',
        data: { labels: arr(stats.blockReasons).map(r => r.block_reason || 'Outro'), datasets: [{ data: arr(stats.blockReasons).map(r => r.count), backgroundColor: colors.pie }] },
        options: { ...chartOpts, plugins: { legend: { position: 'right', labels: { color: '#a0a0b0' } } } }
      });
    }

    // Visitors
    async function loadVisitors() {
      const siteId = document.getElementById('visitorsSiteFilter') ? document.getElementById('visitorsSiteFilter').value : 'all';
      const tbody = document.getElementById('visitorsTable');
      if (tbody) tbody.innerHTML = '<tr><td colspan="11" class="loading"><div class="spinner"></div></td></tr>';
      try {
        const res = await apiGet(`/api/visitors?page=${currentPage}&filter=${currentFilter}&site=${siteId}`);
        if (!res) return;
        const data = await res.json();
        const list = Array.isArray(data && data.visitors) ? data.visitors : [];
        if (list.length === 0) {
          tbody.innerHTML = '<tr><td colspan="11" style="text-align:center;padding:40px;color:var(--text-secondary)">Nenhum visitante encontrado</td></tr>';
          if (document.getElementById('pagination')) document.getElementById('pagination').innerHTML = '';
          return;
        }
        tbody.innerHTML = list.map(v => `
          <tr>
            <td>${formatDateBR(v.created_at)}</td>
            <td><code style="font-size:11px">${v.ip || '-'}</code></td>
            <td><span class="badge badge-info">${v.site_id || 'default'}</span></td>
            <td>${v.was_blocked ? '<span class="badge badge-danger"><i class="ri-close-line"></i> Bloqueado</span>' : '<span class="badge badge-success"><i class="ri-check-line"></i> OK</span>'}${v.is_bot ? ' <span class="badge badge-warning">Bot</span>' : ''}</td>
            <td>${v.country || '-'}</td>
            <td><i class="ri-${v.device_type === 'mobile' ? 'smartphone' : 'computer'}-line"></i> ${v.device_type || 'desktop'}</td>
            <td title="${(v.utm_source || '').replace(/"/g, '')}">${v.utm_source ? (v.utm_source.length > 12 ? v.utm_source.substring(0, 12) + '‚Ä¶' : v.utm_source) : '-'}</td>
            <td title="${(v.utm_medium || '').replace(/"/g, '')}">${v.utm_medium ? (v.utm_medium.length > 12 ? v.utm_medium.substring(0, 12) + '‚Ä¶' : v.utm_medium) : '-'}</td>
            <td title="${(v.utm_campaign || '').replace(/"/g, '')}">${v.utm_campaign ? (v.utm_campaign.length > 12 ? v.utm_campaign.substring(0, 12) + '‚Ä¶' : v.utm_campaign) : '-'}</td>
            <td>${v.browser || '-'}</td>
            <td><button class="btn btn-secondary btn-sm" onclick="viewVisitor(${v.id})"><i class="ri-eye-line"></i></button></td>
          </tr>
        `).join('');

        let pag = '';
        if (data.pages > 1) {
          pag = `<button class="page-btn" ${currentPage <= 1 ? 'disabled' : ''} onclick="goToPage(${currentPage - 1})"><i class="ri-arrow-left-line"></i></button>`;
          for (let i = 1; i <= data.pages; i++) {
            if (i === 1 || i === data.pages || (i >= currentPage - 2 && i <= currentPage + 2)) {
              pag += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
            } else if (i === currentPage - 3 || i === currentPage + 3) pag += '<span style="color:var(--text-secondary)">...</span>';
          }
          pag += `<button class="page-btn" ${currentPage >= data.pages ? 'disabled' : ''} onclick="goToPage(${currentPage + 1})"><i class="ri-arrow-right-line"></i></button>`;
        }
        document.getElementById('pagination').innerHTML = pag;
      } catch (e) { console.error(e); tbody.innerHTML = '<tr><td colspan="11" style="color:var(--danger)">Erro ao carregar</td></tr>'; }
    }

    function goToPage(p) { currentPage = p; loadVisitors(); }

    // Relat√≥rio Permitidos e Bloqueados
    async function loadReports() {
      loadPermitted();
      loadBlocked();
    }

    async function loadPermitted() {
      const siteId = document.getElementById('reportsSiteFilter') ? document.getElementById('reportsSiteFilter').value : 'all';
      const tbody = document.getElementById('permittedTable');
      if (tbody) tbody.innerHTML = '<tr><td colspan="9" class="loading"><div class="spinner"></div></td></tr>';
      try {
        const res = await apiGet(`/api/visitors?page=${permittedPage}&filter=allowed&site=${siteId}&limit=25`);
        if (!res) return;
        const data = await res.json();
        const list = Array.isArray(data && data.visitors) ? data.visitors : [];
        if (list.length === 0) {
          tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:40px;color:var(--text-secondary)">Nenhum visitante permitido</td></tr>';
          if (document.getElementById('permittedPagination')) document.getElementById('permittedPagination').innerHTML = '';
          return;
        }
        tbody.innerHTML = list.map(v => `
          <tr>
            <td>${formatDateBR(v.created_at)}</td>
            <td><span class="badge badge-info">${v.site_id || 'default'}</span></td>
            <td>${v.country || '-'}</td>
            <td><i class="ri-${v.device_type === 'mobile' ? 'smartphone' : 'computer'}-line"></i> ${v.device_type || 'desktop'}</td>
            <td>${v.utm_source || '-'}</td>
            <td>${v.utm_medium || '-'}</td>
            <td>${v.utm_campaign || '-'}</td>
            <td title="${(v.referrer || '').replace(/"/g, '')}">${v.referrer ? (v.referrer.length > 40 ? v.referrer.substring(0, 40) + '...' : v.referrer) : '-'}</td>
            <td><button class="btn btn-secondary btn-sm" onclick="viewVisitor(${v.id})"><i class="ri-eye-line"></i></button></td>
          </tr>
        `).join('');
        let pag = '';
        if (data.pages > 1) {
          pag = `<button class="page-btn" ${permittedPage <= 1 ? 'disabled' : ''} onclick="permittedPage=${permittedPage - 1};loadPermitted()"><i class="ri-arrow-left-line"></i></button>`;
          for (let i = 1; i <= data.pages; i++) {
            if (i === 1 || i === data.pages || (i >= permittedPage - 2 && i <= permittedPage + 2)) {
              pag += `<button class="page-btn ${i === permittedPage ? 'active' : ''}" onclick="permittedPage=${i};loadPermitted()">${i}</button>`;
            } else if (i === permittedPage - 3 || i === permittedPage + 3) pag += '<span style="color:var(--text-secondary)">...</span>';
          }
          pag += `<button class="page-btn" ${permittedPage >= data.pages ? 'disabled' : ''} onclick="permittedPage=${permittedPage + 1};loadPermitted()"><i class="ri-arrow-right-line"></i></button>`;
        }
        document.getElementById('permittedPagination').innerHTML = pag;
      } catch (e) { console.error(e); tbody.innerHTML = '<tr><td colspan="9" style="color:var(--danger)">Erro ao carregar</td></tr>'; }
    }

    async function loadBlocked() {
      const siteId = document.getElementById('reportsSiteFilter') ? document.getElementById('reportsSiteFilter').value : 'all';
      const tbody = document.getElementById('blockedTable');
      if (tbody) tbody.innerHTML = '<tr><td colspan="7" class="loading"><div class="spinner"></div></td></tr>';
      try {
        const res = await apiGet(`/api/visitors?page=${blockedPage}&filter=blocked&site=${siteId}&limit=25`);
        if (!res) return;
        const data = await res.json();
        const list = Array.isArray(data && data.visitors) ? data.visitors : [];
        if (list.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:40px;color:var(--text-secondary)">Nenhum visitante bloqueado</td></tr>';
          if (document.getElementById('blockedPagination')) document.getElementById('blockedPagination').innerHTML = '';
          return;
        }
        tbody.innerHTML = list.map(v => `
          <tr>
            <td>${formatDateBR(v.created_at)}</td>
            <td><span class="badge badge-info">${v.site_id || 'default'}</span></td>
            <td>${v.country || '-'}</td>
            <td><span class="badge badge-danger" title="${(v.block_reason || '').replace(/"/g, '')}">${v.block_reason ? (v.block_reason.length > 35 ? v.block_reason.substring(0, 35) + '...' : v.block_reason) : '-'}</span></td>
            <td><i class="ri-${v.device_type === 'mobile' ? 'smartphone' : 'computer'}-line"></i> ${v.device_type || 'desktop'}</td>
            <td>${v.browser || '-'}</td>
            <td><button class="btn btn-secondary btn-sm" onclick="viewVisitor(${v.id})"><i class="ri-eye-line"></i></button></td>
          </tr>
        `).join('');
        let pag = '';
        if (data.pages > 1) {
          pag = `<button class="page-btn" ${blockedPage <= 1 ? 'disabled' : ''} onclick="blockedPage=${blockedPage - 1};loadBlocked()"><i class="ri-arrow-left-line"></i></button>`;
          for (let i = 1; i <= data.pages; i++) {
            if (i === 1 || i === data.pages || (i >= blockedPage - 2 && i <= blockedPage + 2)) {
              pag += `<button class="page-btn ${i === blockedPage ? 'active' : ''}" onclick="blockedPage=${i};loadBlocked()">${i}</button>`;
            } else if (i === blockedPage - 3 || i === blockedPage + 3) pag += '<span style="color:var(--text-secondary)">...</span>';
          }
          pag += `<button class="page-btn" ${blockedPage >= data.pages ? 'disabled' : ''} onclick="blockedPage=${blockedPage + 1};loadBlocked()"><i class="ri-arrow-right-line"></i></button>`;
        }
        document.getElementById('blockedPagination').innerHTML = pag;
      } catch (e) { console.error(e); tbody.innerHTML = '<tr><td colspan="7" style="color:var(--danger)">Erro ao carregar</td></tr>'; }
    }

    async function viewVisitor(id) {
      document.getElementById('visitorModal').classList.add('active');
      document.getElementById('visitorDetails').innerHTML = '<div class="loading"><div class="spinner"></div></div>';
      try {
        const res = await apiGet(`/api/visitors/${id}`);
        if (!res) return;
        const v = await res.json();
        document.getElementById('visitorDetails').innerHTML = `
          <div class="info-grid">
            <div><h4 style="margin-bottom:15px;color:var(--accent)">üìç Localiza√ß√£o</h4>
              <div class="info-item"><span class="info-label">IP</span><span class="info-value">${v.ip || '-'}</span></div>
              <div class="info-item"><span class="info-label">Pa√≠s</span><span class="info-value">${v.country || '-'}</span></div>
              <div class="info-item"><span class="info-label">Regi√£o</span><span class="info-value">${v.region || '-'}</span></div>
              <div class="info-item"><span class="info-label">Cidade</span><span class="info-value">${v.city || '-'}</span></div>
              <div class="info-item"><span class="info-label">ISP</span><span class="info-value">${v.isp || '-'}</span></div>
            </div>
            <div><h4 style="margin-bottom:15px;color:var(--accent)">üì± Dispositivo</h4>
              <div class="info-item"><span class="info-label">Tipo</span><span class="info-value">${v.device_type || 'desktop'}</span></div>
              <div class="info-item"><span class="info-label">Navegador</span><span class="info-value">${v.browser || '-'} ${v.browser_version || ''}</span></div>
              <div class="info-item"><span class="info-label">Sistema</span><span class="info-value">${v.os || '-'}</span></div>
              <div class="info-item"><span class="info-label">Tela</span><span class="info-value">${(v.screen_width && v.screen_height) ? (v.screen_width + 'x' + v.screen_height) : '-'}</span></div>
            </div>
            <div><h4 style="margin-bottom:15px;color:var(--accent)">üîç Detec√ß√£o</h4>
              <div class="info-item"><span class="info-label">Status</span><span class="info-value">${v.was_blocked ? 'üö´ Bloqueado' : '‚úÖ Permitido'}</span></div>
              <div class="info-item"><span class="info-label">Motivo</span><span class="info-value">${v.block_reason || '-'}</span></div>
              <div class="info-item"><span class="info-label">Bot?</span><span class="info-value">${v.is_bot ? '‚ö†Ô∏è Sim' : 'N√£o'}</span></div>
              <div class="info-item"><span class="info-label">Site</span><span class="info-value">${v.site_id || 'default'}</span></div>
            </div>
            <div><h4 style="margin-bottom:15px;color:var(--accent)">üîó Rastreamento / UTMs (Ads)</h4>
              <div class="info-item"><span class="info-label">Referrer</span><span class="info-value">${v.referrer || '-'}</span></div>
              <div class="info-item"><span class="info-label">UTM Source</span><span class="info-value">${v.utm_source || '-'}</span></div>
              <div class="info-item"><span class="info-label">UTM Medium</span><span class="info-value">${v.utm_medium || '-'}</span></div>
              <div class="info-item"><span class="info-label">UTM Campaign</span><span class="info-value">${v.utm_campaign || '-'}</span></div>
              <div class="info-item"><span class="info-label">UTM Term</span><span class="info-value">${v.utm_term || '-'}</span></div>
              <div class="info-item"><span class="info-label">UTM Content</span><span class="info-value">${v.utm_content || '-'}</span></div>
              <div class="info-item"><span class="info-label">Data (Bras√≠lia)</span><span class="info-value">${formatDateTimeBR(v.created_at)}</span></div>
            </div>
          </div>
          <div style="margin-top:20px"><h4 style="margin-bottom:10px;color:var(--accent)">User-Agent</h4><div class="code-block" style="font-size:11px;word-break:break-all">${v.user_agent || '-'}</div></div>
        `;
      } catch (e) { document.getElementById('visitorDetails').innerHTML = '<p style="color:var(--danger)">Erro ao carregar</p>'; }
    }

    function closeVisitorModal() { document.getElementById('visitorModal').classList.remove('active'); }

    // Script section
    async function loadScriptSection() {
      if (!domainsList || domainsList.length === 0) {
        try {
          const r = await apiGet('/api/domains');
          if (r) {
            const d = await r.json();
            domainsList = d.domains || [];
            systemDefaultDomain = d.defaultDomain || null;
          }
        } catch (e) { }
      }
      updateSiteSelectors();
      updateScriptCode();
    }

    async function generateLinkFromUrl() {
      const url = (document.getElementById('quickTargetUrl').value || '').trim();
      if (!url) { alert('Cole a URL da sua landing page no campo acima.'); return; }
      const name = (document.getElementById('quickSiteName').value || '').trim() || ('Landing ' + new Date().toLocaleDateString('pt-BR'));
      const domainSelect = document.getElementById('quickDomainSelect');
      const selectedDomain = domainSelect ? domainSelect.value : '';
      try {
        const res = await fetch('/api/sites', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            name,
            target_url: url,
            redirect_url: 'https://www.google.com/',
            allowed_countries: 'BR',
            selected_domain: selectedDomain || null
          })
        });
        if (!res.ok) throw new Error('Erro ao criar');
        const site = await res.json();
        const baseUrl = selectedDomain ? getLinkBaseUrl(selectedDomain) : getBaseUrl();
        const link = buildFullLink(site, baseUrl);
        await loadSites();
        document.getElementById('generatedLinkText').textContent = link;
        document.getElementById('generatedLinkBox').style.display = 'block';
        document.getElementById('scriptSiteSelector').value = site.site_id;
        updateScriptCode();
      } catch (e) {
        alert('Erro ao gerar link. Tente novamente.');
      }
    }

    function updateScriptCode() {
      const siteId = document.getElementById('scriptSiteSelector').value;
      const domainSel = document.getElementById('scriptDomainSelect');
      const block = document.getElementById('scriptCodeBlock');
      const code = document.getElementById('scriptCode');
      const refBox = document.getElementById('scriptRefParamBox');
      const refVal = document.getElementById('scriptRefParamValue');
      if (domainSel && domainsList && domainSel.options.length <= 1) {
        domainsList.forEach(d => {
          if (d.domain) {
            const opt = document.createElement('option');
            opt.value = d.domain;
            opt.textContent = d.domain;
            domainSel.appendChild(opt);
          }
        });
        // Atualiza o texto do Padr√£o
        const defaultOpt = domainSel.querySelector('option[value=""]');
        if (defaultOpt) defaultOpt.textContent = systemDefaultDomain ? `Padr√£o (${systemDefaultDomain})` : 'Padr√£o (URL do Painel)';
      }
      if (!siteId) { block.style.display = 'none'; return; }
      block.style.display = 'block';
      const site = sites.find(s => s.site_id === siteId);
      const domainHost = domainSel ? domainSel.value : '';
      const base = getLinkBaseUrl(domainHost);
      if (site && site.link_code) {
        code.textContent = buildFullLink(site, base);
        if (site.required_ref_token && site.required_ref_token.trim()) {
          refBox.style.display = 'block';
          refVal.textContent = 'ref=' + site.required_ref_token;
        } else {
          refBox.style.display = 'none';
        }
      } else {
        code.textContent = 'Salve a URL do seu site e edite o site para gerar o link.';
        refBox.style.display = 'none';
      }
    }

    function copyRefParam() {
      const el = document.getElementById('scriptRefParamValue');
      if (el && el.textContent) { copyToClipboard(el.textContent.trim()); }
    }

    function copyScript() {
      const code = document.getElementById('scriptCode');
      if (code && code.textContent) copyToClipboard(code.textContent.trim());
    }

    function copyToClipboard(text) {
      navigator.clipboard.writeText(text);
      alert('Copiado!');
    }

    function exportData(format) { window.open(`/api/export?format=${format}`, '_blank'); }

    async function logout() {
      try {
        await fetch('/api/logout', { method: 'POST', credentials: 'include' });
        window.location.href = '/login';
      } catch (e) { window.location.href = '/login'; }
    }

    async function loadSettings() {
      try {
        const res = await fetch('/api/me', { credentials: 'include' });
        if (res.ok) {
          const data = await res.json();
          const el = document.getElementById('newUsername');
          if (el) el.value = data.username || '';
        }
      } catch (e) { }
    }

    async function updateUsername() {
      const username = (document.getElementById('newUsername').value || '').trim();
      const msg = document.getElementById('usernameMsg');
      if (!username || username.length < 2) {
        msg.textContent = 'Usu√°rio deve ter pelo menos 2 caracteres.';
        msg.style.color = 'var(--danger)';
        return;
      }
      try {
        const res = await fetch('/api/me/username', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ username })
        });
        if (!res.ok) {
          const data = await res.json();
          throw new Error(data.error || 'Erro ao atualizar');
        }
        msg.textContent = 'Usu√°rio atualizado com sucesso!';
        msg.style.color = 'var(--success)';
        setTimeout(() => { msg.textContent = ''; }, 3000);
      } catch (e) {
        msg.textContent = e.message || 'Erro ao atualizar usu√°rio.';
        msg.style.color = 'var(--danger)';
      }
    }

    async function updatePassword() {
      const current = (document.getElementById('currentPassword').value || '').trim();
      const newPass = (document.getElementById('newPassword').value || '').trim();
      const confirm = (document.getElementById('confirmPassword').value || '').trim();
      const msg = document.getElementById('passwordMsg');
      if (!current || !newPass || newPass.length < 6) {
        msg.textContent = 'Preencha a senha atual e a nova senha (m√≠n. 6 caracteres).';
        msg.style.color = 'var(--danger)';
        return;
      }
      if (newPass !== confirm) {
        msg.textContent = 'As senhas n√£o coincidem.';
        msg.style.color = 'var(--danger)';
        return;
      }
      try {
        const res = await fetch('/api/me/password', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ currentPassword: current, newPassword: newPass })
        });
        if (!res.ok) {
          const data = await res.json();
          throw new Error(data.error || 'Erro ao atualizar');
        }
        msg.textContent = 'Senha atualizada com sucesso!';
        msg.style.color = 'var(--success)';
        document.getElementById('currentPassword').value = '';
        document.getElementById('newPassword').value = '';
        document.getElementById('confirmPassword').value = '';
        setTimeout(() => { msg.textContent = ''; }, 3000);
      } catch (e) {
        msg.textContent = e.message || 'Erro ao atualizar senha.';
        msg.style.color = 'var(--danger)';
      }
    }

    async function checkPropagation() {
      const btn = document.getElementById('checkPropagationBtn');
      const box = document.getElementById('propagationResult');
      const msgEl = document.getElementById('propagationMessage');
      const detailsEl = document.getElementById('propagationDetails');
      const url = (document.getElementById('cloakerBaseUrl').value || '').trim();
      if (!url) {
        msgEl.textContent = 'Preencha a URL base do seu Cloaker acima e clique em Salvar antes de testar.';
        msgEl.style.background = 'rgba(255, 193, 7, 0.2)';
        msgEl.style.color = 'var(--warning)';
        box.style.display = 'block';
        detailsEl.style.display = 'none';
        return;
      }
      btn.disabled = true;
      btn.innerHTML = '<i class="ri-loader-4-line" style="animation: spin 1s linear infinite;"></i> Verificando...';
      box.style.display = 'block';
      msgEl.textContent = 'Consultando DNS e testando resposta...';
      msgEl.style.background = 'rgba(23, 162, 184, 0.2)';
      msgEl.style.color = '#17a2b8';
      detailsEl.style.display = 'none';
      try {
        const res = await fetch('/api/settings/check-propagation?url=' + encodeURIComponent(url), { credentials: 'include' });
        const data = await res.json();
        if (data.ok) {
          msgEl.innerHTML = '<i class="ri-checkbox-circle-fill" style="color: var(--success); margin-right: 8px;"></i> ' + (data.message || 'Dom√≠nio propagado e respondendo.');
          msgEl.style.background = 'rgba(0, 217, 165, 0.2)';
          msgEl.style.color = 'var(--success)';
        } else {
          msgEl.innerHTML = '<i class="ri-information-line" style="margin-right: 8px;"></i> ' + (data.message || 'Aguardando propaga√ß√£o.');
          msgEl.style.background = 'rgba(255, 193, 7, 0.2)';
          msgEl.style.color = 'var(--warning)';
        }
        if (data.details && (data.details.cname?.length || data.details.ips?.length)) {
          detailsEl.textContent = 'DNS: ' + (data.details.cname?.length ? 'CNAME ‚Üí ' + data.details.cname.join(', ') : '') + (data.details.ips?.length ? ' | IPs: ' + data.details.ips.join(', ') : '') + ' | Responde: ' + (data.details.reachable ? 'sim' : 'n√£o');
          detailsEl.style.display = 'block';
        } else {
          detailsEl.style.display = 'none';
        }
      } catch (e) {
        msgEl.innerHTML = '<i class="ri-error-warning-line" style="color: var(--danger); margin-right: 8px;"></i> Erro ao verificar. Tente novamente.';
        msgEl.style.background = 'rgba(220, 53, 69, 0.2)';
        msgEl.style.color = 'var(--danger)';
        detailsEl.style.display = 'none';
      }
      btn.disabled = false;
      btn.innerHTML = '<i class="ri-search-line"></i> Testar propaga√ß√£o';
    }

    function userStatusBadge(status) {
      const s = (status || 'active').toLowerCase();
      if (s === 'active') return '<span class="badge badge-success">Ativo</span>';
      if (s === 'pending') return '<span class="badge badge-warning">Pendente</span>';
      if (s === 'banned') return '<span class="badge badge-danger">Bloqueado</span>';
      if (s === 'paused') return '<span class="badge badge-warning">Pausado</span>';
      return '<span class="badge badge-info">' + (status || 'Ativo') + '</span>';
    }

    async function loadUsers() {
      const tbodyPending = document.getElementById('usersPendingTable');
      const tbodyActive = document.getElementById('usersTable');
      const emptyPending = document.getElementById('usersPendingEmpty');
      if (tbodyPending) tbodyPending.innerHTML = '<tr><td colspan="3" class="loading"><div class="spinner"></div></td></tr>';
      if (tbodyActive) tbodyActive.innerHTML = '<tr><td colspan="5" class="loading"><div class="spinner"></div></td></tr>';
      try {
        const res = await apiGet('/api/users');
        if (!res) return;
        const users = await res.json();
        const list = Array.isArray(users) ? users : [];
        const pending = list.filter(u => (u.status || '') === 'pending');
        const notPending = list.filter(u => (u.status || '') !== 'pending');
        if (tbodyPending) {
          if (pending.length === 0) {
            tbodyPending.innerHTML = '';
            if (emptyPending) emptyPending.style.display = 'block';
          } else {
            if (emptyPending) emptyPending.style.display = 'none';
            tbodyPending.innerHTML = pending.map(u => `
              <tr>
                <td>${u.username}</td>
                <td>${formatDateBR(u.created_at)}</td>
                <td>
                  <button class="btn btn-primary btn-sm" onclick="approveUser(${u.id})"><i class="ri-check-line"></i> Aprovar</button>
                  <button class="btn btn-danger btn-sm" onclick="rejectUser(${u.id})" style="margin-left:8px"><i class="ri-close-line"></i> Rejeitar</button>
                </td>
              </tr>
            `).join('');
          }
        }
        if (tbodyActive) {
          const meId = (currentUser && currentUser.id) ? currentUser.id : null;
          tbodyActive.innerHTML = notPending.length === 0 ? '<tr><td colspan="5" style="text-align:center;padding:30px;color:var(--text-secondary)">Nenhum usu√°rio</td></tr>' : notPending.map(u => {
            const status = u.status || 'active';
            const isSelf = (meId && parseInt(u.id, 10) === parseInt(meId, 10));
            let actions = '';
            if (!isSelf) {
              actions += '<button class="btn btn-secondary btn-sm" onclick="openChangePasswordModal(' + u.id + ', \'' + (u.username || '').replace(/'/g, "\\'") + '\')" title="Alterar senha"><i class="ri-key-line"></i></button> ';
              if (status === 'active') {
                actions += '<button class="btn btn-sm" style="background:var(--warning);color:#000" onclick="pauseUser(' + u.id + ')" title="Pausar"><i class="ri-pause-line"></i></button> ';
                actions += '<button class="btn btn-danger btn-sm" onclick="banUser(' + u.id + ')" title="Banir"><i class="ri-forbid-line"></i></button> ';
              } else {
                actions += '<button class="btn btn-primary btn-sm" onclick="activateUser(' + u.id + ')" title="Ativar"><i class="ri-play-line"></i></button> ';
              }
              actions += '<button class="btn btn-danger btn-sm" onclick="deleteUser(' + u.id + ', \'' + (u.username || '').replace(/'/g, "\\'") + '\')" title="Excluir usu√°rio"><i class="ri-delete-bin-line"></i></button>';
            } else {
              actions = '<span style="color:var(--text-secondary);font-size:12px">(voc√™)</span>';
            }
            return `
            <tr>
              <td>${u.username}</td>
              <td><span class="badge ${u.role === 'admin' ? 'badge-danger' : 'badge-info'}">${u.role === 'admin' ? 'Admin' : 'Usu√°rio'}</span></td>
              <td>${userStatusBadge(status)}</td>
              <td>${formatDateBR(u.created_at)}</td>
              <td style="white-space:nowrap">${actions}</td>
            </tr>
          `;
          }).join('');
        }
      } catch (e) {
        if (tbodyPending) tbodyPending.innerHTML = '<tr><td colspan="3" style="color:var(--danger)">Erro ao carregar</td></tr>';
        if (tbodyActive) tbodyActive.innerHTML = '<tr><td colspan="5" style="color:var(--danger)">Erro ao carregar</td></tr>';
      }
    }

    function openChangePasswordModal(userId, username) {
      window._passwordUserId = userId;
      document.getElementById('changePasswordUsername').textContent = username || '';
      document.getElementById('changePasswordNew').value = '';
      document.getElementById('changePasswordModal').classList.add('active');
    }

    function closeChangePasswordModal() {
      document.getElementById('changePasswordModal').classList.remove('active');
    }

    async function submitChangePassword() {
      const userId = window._passwordUserId;
      const newPass = document.getElementById('changePasswordNew').value;
      if (!newPass || newPass.length < 6) { alert('Senha com pelo menos 6 caracteres.'); return; }
      try {
        const res = await fetch('/api/users/' + userId + '/password', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, credentials: 'include', body: JSON.stringify({ password: newPass }) });
        if (res.status === 401) { window.location.href = '/login'; return; }
        if (!res.ok) { const e = await res.json(); throw new Error(e.error || 'Erro'); }
        closeChangePasswordModal();
        loadUsers();
        alert('Senha alterada.');
      } catch (e) { alert(e.message || 'Erro ao alterar senha.'); }
    }

    async function banUser(id) {
      if (!confirm('Banir este usu√°rio? Ele n√£o poder√° mais fazer login.')) return;
      try {
        const res = await fetch('/api/users/' + id + '/ban', { method: 'POST', credentials: 'include' });
        if (res.status === 401) { window.location.href = '/login'; return; }
        if (!res.ok) { const d = await res.json(); alert(d.error || 'Erro'); return; }
        loadUsers();
      } catch (e) { }
    }

    async function pauseUser(id) {
      if (!confirm('Pausar este usu√°rio? Ele n√£o poder√° fazer login at√© voc√™ ativ√°-lo novamente.')) return;
      try {
        const res = await fetch('/api/users/' + id + '/pause', { method: 'POST', credentials: 'include' });
        if (res.status === 401) { window.location.href = '/login'; return; }
        if (!res.ok) { const d = await res.json(); alert(d.error || 'Erro'); return; }
        loadUsers();
      } catch (e) { }
    }

    async function activateUser(id) {
      try {
        const res = await fetch('/api/users/' + id + '/activate', { method: 'POST', credentials: 'include' });
        if (res.status === 401) { window.location.href = '/login'; return; }
        if (!res.ok) { const d = await res.json(); alert(d.error || 'Erro'); return; }
        loadUsers();
      } catch (e) { }
    }

    async function deleteUser(id, username) {
      if (!confirm('Excluir o usu√°rio "' + username + '"? Todos os sites e visitantes dele ser√£o removidos. Esta a√ß√£o n√£o pode ser desfeita.')) return;
      try {
        const res = await fetch('/api/users/' + id, { method: 'DELETE', credentials: 'include' });
        if (res.status === 401) { window.location.href = '/login'; return; }
        if (!res.ok) { const d = await res.json(); alert(d.error || 'Erro'); return; }
        loadUsers();
      } catch (e) { }
    }

    async function approveUser(id) {
      try {
        const res = await fetch('/api/users/' + id + '/approve', { method: 'POST', credentials: 'include' });
        if (res.status === 401) { window.location.href = '/login'; return; }
        if (!res.ok) throw new Error();
        loadUsers();
      } catch (e) { }
    }

    async function rejectUser(id) {
      if (!confirm('Rejeitar esta solicita√ß√£o? O usu√°rio ser√° removido.')) return;
      try {
        const res = await fetch('/api/users/' + id + '/reject', { method: 'POST', credentials: 'include' });
        if (res.status === 401) { window.location.href = '/login'; return; }
        if (!res.ok) throw new Error();
        loadUsers();
      } catch (e) { }
    }

    let cnameTargetCache = '';
    let domainsList = [];
    let pagesList = [];

    function getLinkBaseUrl(domainHost) {
      if (domainHost) return (domainHost.startsWith('http') ? domainHost : 'https://' + domainHost).replace(/\/$/, '');
      // Se n√£o tem dom√≠nio selecionado, usa o Default do sistema (se houver) ou a origem atual
      if (systemDefaultDomain) return 'https://' + systemDefaultDomain;
      return getBaseUrl();
    }

    function buildFullLink(site, baseUrl) {
      if (!site || !site.link_code) return '';
      const path = buildLinkBase(site, baseUrl);
      const qs = buildLinkParams(site);
      return qs ? path + '?' + qs : path;
    }

    /** Apenas o dom√≠nio gerado: base + /go/code (sem query string) */
    function buildLinkBase(site, baseUrl) {
      if (!site || !site.link_code) return '';
      const base = (baseUrl || getBaseUrl()).replace(/\/$/, '');
      return base + '/go/' + site.link_code;
    }

    /** Apenas os par√¢metros: ref=...&utm_... (sem "?", string vazia se n√£o houver) */
    function buildLinkParams(site) {
      if (!site) return '';
      const params = [];
      if (site.required_ref_token && site.required_ref_token.trim()) params.push('ref=' + encodeURIComponent(site.required_ref_token));
      const def = (site.default_link_params || '').trim();
      if (def) params.push(def.startsWith('&') ? def.slice(1) : def);
      return params.length ? params.join('&') : '';
    }

    async function saveSelectedDomain(siteId, domain) {
      try {
        await fetch(`/api/sites/${siteId}/selected-domain`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ selected_domain: domain || '' })
        });
        const site = sites.find(s => s.site_id === siteId);
        if (site) site.selected_domain = domain || null;
      } catch (e) {
        console.error('Erro ao salvar dom√≠nio selecionado:', e);
      }
    }

    function updateSiteLinkDisplays(siteId) {
      saveSelectedDomain(siteId, document.getElementById('domainSelect-' + siteId)?.value || '');
      const site = sites.find(s => s.site_id === siteId);
      const baseUrl = getLinkBaseUrl(document.getElementById('domainSelect-' + siteId)?.value || '');
      const baseEl = document.getElementById('linkBase-' + siteId);
      const paramsEl = document.getElementById('linkParams-' + siteId);
      if (baseEl) baseEl.textContent = site && site.link_code ? buildLinkBase(site, baseUrl) : '‚Äî';
      if (paramsEl) paramsEl.textContent = site && site.link_code ? (buildLinkParams(site) || '‚Äî') : '‚Äî';
    }

    function copySiteLinkBase(siteId) {
      const site = sites.find(s => s.site_id === siteId);
      if (!site || !site.link_code) { alert('Edite o site e salve a URL do seu site para gerar o link.'); return; }
      const baseUrl = getLinkBaseUrl(document.getElementById('domainSelect-' + siteId)?.value || '');
      const base = buildLinkBase(site, baseUrl);
      if (base) copyToClipboard(base);
    }

    function copySiteLinkParams(siteId) {
      const site = sites.find(s => s.site_id === siteId);
      if (!site) return;
      const params = buildLinkParams(site);
      if (params) copyToClipboard(params);
      else copyToClipboard('');
    }

    function copySiteLink(siteId) {
      const site = sites.find(s => s.site_id === siteId);
      if (!site || !site.link_code) { alert('Edite o site e salve a URL do seu site para gerar o link.'); return; }
      const sel = document.getElementById('domainSelect-' + siteId);
      const domainHost = sel ? sel.value : '';
      const full = buildFullLink(site, getLinkBaseUrl(domainHost));
      if (full) copyToClipboard(full);
    }

    // ---------- P√°ginas HTML ----------
    async function loadPages() {
      const listEl = document.getElementById('pagesList');
      const emptyEl = document.getElementById('pagesEmpty');
      if (listEl) listEl.innerHTML = '<div class="loading" style="grid-column:1/-1"><div class="spinner"></div></div>';
      if (emptyEl) emptyEl.style.display = 'none';
      try {
        const res = await apiGet('/api/pages');
        if (!res) { pagesList = []; if (listEl) listEl.innerHTML = ''; if (emptyEl) emptyEl.style.display = 'block'; return; }
        const list = await res.json();
        pagesList = Array.isArray(list) ? list : [];
        if (listEl) {
          if (pagesList.length === 0) { listEl.innerHTML = ''; if (emptyEl) emptyEl.style.display = 'block'; }
          else {
            if (emptyEl) emptyEl.style.display = 'none';
            listEl.innerHTML = pagesList.map(p => {
              const name = (p.name || 'P√°gina ' + p.id).replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
              return `<div class="card" style="margin-bottom: 0;">
                <div class="card-body" style="padding: 16px;">
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <strong>${name}</strong>
                    <div style="display: flex; gap: 8px;">
                      <button class="btn btn-sm btn-secondary" onclick="openPageModal(${p.id})"><i class="ri-edit-line"></i></button>
                      <button class="btn btn-sm btn-danger" onclick="deletePage(${p.id})"><i class="ri-delete-bin-line"></i></button>
                    </div>
                  </div>
                </div>
              </div>`;
            }).join('');
          }
        }
        fillSiteModalDomainsAndPages();
      } catch (e) { pagesList = []; if (listEl) listEl.innerHTML = ''; if (emptyEl) emptyEl.style.display = 'block'; }
    }
    async function openPageModal(id) {
      document.getElementById('pageModalTitle').textContent = id ? 'Editar p√°gina' : 'Nova p√°gina';
      document.getElementById('editPageId').value = id || '';
      document.getElementById('pageName').value = id ? (pagesList.find(p => p.id == id)?.name || '') : '';
      document.getElementById('pageHtml').value = '';
      if (id) {
        try {
          const res = await fetch('/api/pages/' + id, { credentials: 'include' });
          if (res.ok) { const p = await res.json(); document.getElementById('pageName').value = p.name || ''; document.getElementById('pageHtml').value = p.html_content || ''; }
        } catch (e) { }
      }
      document.getElementById('pageModal').classList.add('active');
    }
    function closePageModal() {
      document.getElementById('pageModal').classList.remove('active');
    }
    async function savePage() {
      const id = document.getElementById('editPageId').value;
      const name = document.getElementById('pageName').value.trim();
      const html_content = document.getElementById('pageHtml').value;
      if (!name) { alert('Digite um nome para a p√°gina.'); return; }
      try {
        if (id) {
          await fetch(`/api/pages/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, credentials: 'include', body: JSON.stringify({ name, html_content }) });
        } else {
          await fetch('/api/pages', { method: 'POST', headers: { 'Content-Type': 'application/json' }, credentials: 'include', body: JSON.stringify({ name, html_content }) });
        }
        closePageModal();
        loadPages();
      } catch (e) { alert('Erro ao salvar p√°gina.'); }
    }
    async function deletePage(id) {
      const p = pagesList.find(x => x.id == id);
      const name = p ? (p.name || 'P√°gina ' + id) : '';
      if (!confirm('Excluir a p√°gina "' + name + '"? Sites que usam ela voltar√£o a usar redirecionamento.')) return;
      try {
        await fetch(`/api/pages/${id}`, { method: 'DELETE', credentials: 'include' });
        loadPages();
        loadSites();
      } catch (e) { alert('Erro ao excluir.'); }
    }

    function copyCnameTarget() {
      const t = cnameTargetCache || document.getElementById('cnameTargetPlaceholder')?.textContent || '';
      if (!t || t === 'carregando...') return;
      if (navigator.clipboard && navigator.clipboard.writeText) { navigator.clipboard.writeText(t).then(() => alert('Destino CNAME copiado.')).catch(() => fallbackCopy(t)); }
      else fallbackCopy(t);
    }
    function fallbackCopy(text) {
      const ta = document.createElement('textarea'); ta.value = text; ta.style.position = 'fixed'; ta.style.opacity = '0'; document.body.appendChild(ta); ta.select(); try { document.execCommand('copy'); alert('Destino CNAME copiado.'); } catch (e) { } document.body.removeChild(ta);
    }
    async function loadDomains() {
      const tbody = document.getElementById('domainsTable');
      const empty = document.getElementById('domainsEmpty');
      const ph = document.getElementById('cnameTargetPlaceholder');
      if (!tbody) return;
      try {
        const res = await apiGet('/api/domains');
        if (!res) return;
        const data = await res.json();
        const list = data.domains || (Array.isArray(data) ? data : []);
        domainsList = list;
        cnameTargetCache = data.cnameTarget || '';
        if (ph) ph.textContent = cnameTargetCache || '(cada dom√≠nio mostra o valor na tabela abaixo)';

        // Atualizar dropdowns de dom√≠nio
        const quickDomainSelect = document.getElementById('quickDomainSelect');
        if (quickDomainSelect) {
          const currentVal = quickDomainSelect.value;
          quickDomainSelect.innerHTML = '<option value="">Padr√£o</option>' + list.map(d => `<option value="${d.domain || ''}">${d.domain || ''}</option>`).join('');
          quickDomainSelect.value = currentVal || '';
        }

        if (list.length === 0) {
          tbody.innerHTML = '';
          if (empty) empty.style.display = 'block';
          return;
        }
        if (empty) empty.style.display = 'none';
        const target = cnameTargetCache || 'seu-app.up.railway.app';
        tbody.innerHTML = list.map(d => {
          var cnameVal = d.railway_cname_target || target;
          if (!cnameVal) cnameVal = '(recadastre o dom√≠nio para obter o valor do Railway)';
          var cnameEsc = (cnameVal || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
          var cnameJs = (d.railway_cname_target || target || '').replace(/\\/g, '\\\\').replace(/'/g, "\\'");
          var copyBtn = (d.railway_cname_target || target) ? '<button type="button" class="btn btn-sm btn-secondary" onclick="copyDomainCname(' + d.id + ')" title="Copiar Valor CNAME"><i class="ri-file-copy-line"></i></button>' : '';
          var descEsc = (d.description || '-').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
          return '<tr><td>' + descEsc + '</td><td><code>' + (d.domain || '') + '</code></td><td><code>CNAME</code></td><td><code>@</code></td><td><code id="cnameVal-' + d.id + '" style="font-size:11px">' + cnameEsc + '</code> ' + copyBtn + '</td><td><button type="button" class="btn btn-sm btn-secondary" onclick="checkDomainDns(\'' + (d.domain || '').replace(/'/g, "\\'") + '\', ' + d.id + ', \'' + cnameJs + '\')" title="Verificar se o DNS j√° propagou"><i class="ri-search-line"></i> Verificar</button><span id="dnsResult-' + d.id + '" style="margin-left:6px;font-size:12px"></span></td><td><button type="button" class="btn btn-sm btn-danger" onclick="deleteDomain(' + d.id + ')"><i class="ri-delete-bin-line"></i></button></td></tr>';
        }).join('');
      } catch (e) {
        tbody.innerHTML = '<tr><td colspan="7">Erro ao carregar</td></tr>';
      }
    }

    async function addDomain() {
      const name = (document.getElementById('newDomainName').value || '').trim();
      const desc = (document.getElementById('newDomainDesc').value || '').trim();
      const msg = document.getElementById('domainMsg');
      if (!name) { if (msg) msg.textContent = 'Informe o dom√≠nio'; return; }
      if (msg) msg.textContent = '';
      try {
        const res = await fetch('/api/domains', { method: 'POST', headers: { 'Content-Type': 'application/json' }, credentials: 'include', body: JSON.stringify({ domain: name, description: desc }) });
        if (res.status === 401) { window.location.href = '/login'; return; }
        const data = await res.json();
        if (!res.ok) { if (msg) msg.textContent = data.error || 'Erro'; return; }
        document.getElementById('newDomainName').value = '';
        document.getElementById('newDomainDesc').value = '';
        document.getElementById('domainModal').classList.remove('active');
        loadDomains();
        if (data.nextStep) { if (msg) msg.textContent = ''; alert('Dom√≠nio cadastrado. ' + data.nextStep + (data.railwayError ? '\n\nErro Railway: ' + data.railwayError : '')); }
      } catch (e) { if (msg) msg.textContent = 'Erro de conex√£o'; }
    }

    function copyDomainCname(rowId) {
      const el = document.getElementById('cnameVal-' + rowId);
      const t = (el && el.textContent) ? el.textContent.trim() : '';
      if (!t) return;
      if (navigator.clipboard && navigator.clipboard.writeText) { navigator.clipboard.writeText(t).then(() => alert('Valor CNAME copiado.')).catch(() => fallbackCopy(t)); }
      else fallbackCopy(t);
    }
    async function checkDomainDns(domain, rowId, targetOptional) {
      const span = document.getElementById('dnsResult-' + rowId);
      if (span) span.textContent = '...';
      try {
        const target = (targetOptional && targetOptional.length) ? encodeURIComponent(targetOptional) : (cnameTargetCache ? encodeURIComponent(cnameTargetCache) : '');
        const res = await fetch('/api/domains/check-dns?domain=' + encodeURIComponent(domain) + (target ? '&target=' + target : ''), { credentials: 'include' });
        const data = await res.json().catch(() => ({}));
        if (span) {
          if (data.propagated) span.innerHTML = '<span style="color:var(--success)"><i class="ri-checkbox-circle-fill"></i> Propagado</span>';
          else span.innerHTML = '<span style="color:var(--text-secondary)" title="' + (data.message || '').replace(/"/g, '&quot;') + '"><i class="ri-time-line"></i> ' + (data.message ? (data.message.length > 40 ? data.message.slice(0, 40) + '‚Ä¶' : data.message) : 'Aguardando') + '</span>';
        }
      } catch (e) {
        if (span) span.innerHTML = '<span style="color:var(--danger)">Erro</span>';
      }
    }

    async function deleteDomain(id) {
      if (!confirm('Remover este dom√≠nio da lista?')) return;
      try {
        const res = await fetch('/api/domains/' + id, { method: 'DELETE', credentials: 'include' });
        if (res.status === 401) { window.location.href = '/login'; return; }
        loadDomains();
      } catch (e) { }
    }

    async function sendBackup() {
      const msg = document.getElementById('backupMsg');
      if (msg) msg.textContent = 'Enviando...';
      try {
        const res = await fetch('/api/backup/send', { method: 'POST', credentials: 'include' });
        const data = await res.json().catch(() => ({}));
        if (msg) msg.textContent = res.ok ? (data.message || 'Enviado.') : (data.error || 'Erro.');
      } catch (e) {
        if (msg) msg.textContent = 'Erro de conex√£o';
      }
    }

    async function createUser() {
      const username = (document.getElementById('newUserUsername').value || '').trim();
      const password = document.getElementById('newUserPassword').value;
      const role = document.getElementById('newUserRole').value;
      const msg = document.getElementById('userMsg');
      if (!username || username.length < 2) { msg.textContent = 'Usu√°rio com pelo menos 2 caracteres.'; msg.style.color = 'var(--danger)'; return; }
      if (!password || password.length < 6) { msg.textContent = 'Senha com pelo menos 6 caracteres.'; msg.style.color = 'var(--danger)'; return; }
      try {
        const res = await fetch('/api/users', { method: 'POST', headers: { 'Content-Type': 'application/json' }, credentials: 'include', body: JSON.stringify({ username, password, role }) });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Erro');
        msg.textContent = 'Usu√°rio criado.';
        msg.style.color = 'var(--success)';
        document.getElementById('newUserUsername').value = '';
        document.getElementById('newUserPassword').value = '';
        loadUsers();
        setTimeout(() => { msg.textContent = ''; document.getElementById('userModal').classList.remove('active'); }, 1500);
      } catch (e) { msg.textContent = e.message || 'Erro ao criar usu√°rio.'; msg.style.color = 'var(--danger)'; }
    }

    // Init
    (async function init() {
      try {
        const meRes = await apiGet('/api/me');
        if (meRes && meRes.ok) {
          currentUser = await meRes.json();
          if (currentUser && currentUser.role === 'admin') {
            var nu = document.getElementById('navUsers');
            if (nu) nu.style.display = 'block';
            var bc = document.getElementById('backupCard');
            if (bc) bc.style.display = 'block';
          }
        }
        const setRes = await apiGet('/api/settings');
        if (setRes && setRes.ok) { const s = await setRes.json(); baseUrlOrOrigin = (s.cloaker_base_url || '').trim() || window.location.origin; }
      } catch (e) { }
      fillCountrySelects();
      loadSites();
      refreshStats();
    })();
    setInterval(() => { if (document.getElementById('dashboard').classList.contains('active')) refreshStats(); }, 30000);

    document.getElementById('visitorModal').addEventListener('click', e => { if (e.target.id === 'visitorModal') closeVisitorModal(); });
    document.getElementById('siteModal').addEventListener('click', e => { if (e.target.id === 'siteModal') closeSiteModal(); });
    [document.getElementById('siteBlockBehaviorRedirect'), document.getElementById('siteBlockBehaviorEmbed'), document.getElementById('siteBlockBehaviorPage')].forEach(el => {
      if (el) el.addEventListener('change', () => { document.getElementById('sitePageSelectBox').style.display = document.getElementById('siteBlockBehaviorPage').checked ? 'block' : 'none'; });
    });
    document.getElementById('userModal').addEventListener('click', e => { if (e.target.id === 'userModal') document.getElementById('userModal').classList.remove('active'); });
    document.getElementById('changePasswordModal').addEventListener('click', e => { if (e.target.id === 'changePasswordModal') closeChangePasswordModal(); });
    document.getElementById('domainModal').addEventListener('click', e => { if (e.target.id === 'domainModal') document.getElementById('domainModal').classList.remove('active'); });
  </script>
</body>

</html>